---
phase: 20-exercise-delete
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/surfaces/dashboard/DashboardSurface.tsx
  - packages/shared/src/services/templates.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Workout templates reflect deleted exercises immediately without page refresh"
    - "Deleted exercises are filtered out of template exercise lists, not shown as Unknown Exercise"
  artifacts:
    - path: "apps/web/src/surfaces/dashboard/DashboardSurface.tsx"
      provides: "handleExerciseDeleted refreshes both charts AND templates"
      contains: "loadTemplates"
    - path: "packages/shared/src/services/templates.ts"
      provides: "transformTemplate filters out deleted exercises"
      contains: "filter"
  key_links:
    - from: "DashboardSurface.tsx handleExerciseDeleted"
      to: "loadTemplates()"
      via: "await call inside handler"
      pattern: "loadTemplates\\(\\)"
    - from: "templates.ts transformTemplate"
      to: "filtered template_exercises"
      via: "filter on te.exercises !== null"
      pattern: "filter.*exercises"
---

<objective>
Fix stale template data after exercise deletion.

Purpose: UAT test 8 found that after deleting an exercise, workout templates still show the deleted exercise until page refresh. Two root causes: (1) handleExerciseDeleted does not reload templates, and (2) transformTemplate includes deleted exercises with fallback name "Unknown Exercise" instead of filtering them out.

Output: Both files patched so templates update immediately and exclude deleted exercises.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/src/surfaces/dashboard/DashboardSurface.tsx
@packages/shared/src/services/templates.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refresh templates on exercise delete and filter deleted exercises</name>
  <files>
    apps/web/src/surfaces/dashboard/DashboardSurface.tsx
    packages/shared/src/services/templates.ts
  </files>
  <action>
**Fix 1 - DashboardSurface.tsx (lines 430-432):**

Update `handleExerciseDeleted` to also call `loadTemplates()` alongside `loadUserCharts()`. Both calls are independent and can run in parallel with `Promise.all` or sequentially with two awaits. The function currently is:

```typescript
const handleExerciseDeleted = useCallback(async () => {
  await loadUserCharts();
}, []);
```

Change it to:

```typescript
const handleExerciseDeleted = useCallback(async () => {
  await Promise.all([loadUserCharts(), loadTemplates()]);
}, []);
```

Update the JSDoc comment above the function (line 427) to mention both charts and templates are refreshed.

**Fix 2 - packages/shared/src/services/templates.ts (lines 81-108):**

In the `transformTemplate` function, after sorting `template_exercises` (line 81-83), add a filter step to exclude entries where `te.exercises` is null (meaning the exercise was deleted and CASCADE removed the FK but the join returns null). Change:

```typescript
const sortedTemplateExercises = (template.template_exercises || []).sort(
  (a, b) => a.order - b.order
);
```

To:

```typescript
const sortedTemplateExercises = (template.template_exercises || [])
  .filter((te) => te.exercises !== null)
  .sort((a, b) => a.order - b.order);
```

This ensures deleted exercises are excluded from template data rather than appearing as "Unknown Exercise". The filter runs before sort for efficiency (fewer items to sort).

Do NOT change the fallback `'Unknown Exercise'` string on line 103 -- keep it as a safety net for any edge cases, but the filter ensures it is never reached for deleted exercises.
  </action>
  <verify>
1. Run `npx tsc --noEmit` from apps/web to confirm no TypeScript errors.
2. Grep DashboardSurface.tsx for `loadTemplates` -- should appear inside handleExerciseDeleted.
3. Grep templates.ts for `filter.*exercises` -- should appear before the sort in transformTemplate.
4. Run `npm run build` from root to confirm full build passes.
  </verify>
  <done>
- handleExerciseDeleted calls both loadUserCharts() and loadTemplates() so templates refresh immediately after exercise deletion
- transformTemplate filters out template_exercises where te.exercises is null so deleted exercises never appear in template data
- Build passes with no errors
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes in apps/web
2. Full build: `npm run build` passes from repository root
3. Code inspection: handleExerciseDeleted contains both loadUserCharts() and loadTemplates() calls
4. Code inspection: transformTemplate has .filter((te) => te.exercises !== null) before .sort()
</verification>

<success_criteria>
- Deleting an exercise refreshes both chart state AND template state in the dashboard
- Templates with deleted exercises exclude those exercises from their exercise list
- No TypeScript or build errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/20-exercise-delete/20-03-SUMMARY.md`
</output>
