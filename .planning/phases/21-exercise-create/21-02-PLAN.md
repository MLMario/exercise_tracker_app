---
phase: 21-exercise-create
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/services/exercises.ts
  - apps/web/src/surfaces/dashboard/SettingsPanel.tsx
  - apps/web/src/surfaces/dashboard/MyExercisesList.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Creating 'bench press' when 'Bench Press' exists shows duplicate error"
    - "Modal cannot be dismissed by tapping backdrop while save is in progress"
    - "Modal cannot be dismissed by tapping back button while save is in progress"
  artifacts:
    - path: "packages/shared/src/services/exercises.ts"
      provides: "Case-insensitive duplicate check in createExercise"
      contains: "ilike.*name"
    - path: "apps/web/src/surfaces/dashboard/SettingsPanel.tsx"
      provides: "Backdrop and back button guarded during active creation"
      contains: "isCreating"
    - path: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      provides: "isCreating callback exposed to parent"
      contains: "onCreatingChange"
  key_links:
    - from: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      to: "apps/web/src/surfaces/dashboard/SettingsPanel.tsx"
      via: "onCreatingChange callback prop"
      pattern: "onCreatingChange"
    - from: "packages/shared/src/services/exercises.ts"
      to: "supabase"
      via: "ilike query before insert"
      pattern: "ilike.*name.*trimmedName"
---

<objective>
Fix two UAT-reported issues in the exercise create flow:

1. Case-insensitive duplicate name detection on create (Test 6) -- createExercise() allows "bench press" when "Bench Press" exists because it has no pre-insert .ilike() check and the DB has no unique constraint.

2. Modal dismiss guard during save (Test 7) -- SettingsPanel backdrop click and back button can close the panel (and destroy the create modal) while a save is in progress because isCreating state is local to MyExercisesList and never exposed to SettingsPanel.

Purpose: Close the 2 remaining UAT gaps so Phase 21 passes all 7 tests.
Output: Patched service and components with both bugs fixed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-exercise-create/21-01-SUMMARY.md
@.planning/phases/21-exercise-create/21-UAT.md
@.planning/debug/case-insensitive-dup-create.md
@.planning/debug/modal-dismiss-during-save.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add case-insensitive duplicate check to createExercise</name>
  <files>packages/shared/src/services/exercises.ts</files>
  <action>
In the `createExercise()` function (lines 88-151), add a case-insensitive duplicate name check BEFORE the INSERT, modeled on the existing pattern in `updateExercise()` (lines 341-353).

Specifically, after the input validation block (after line 113) and before the INSERT block (line 116), add:

```typescript
// Case-insensitive duplicate check, scoped to user's custom exercises
const trimmedName = name.trim();
const { data: existing } = await supabase
  .from('exercises')
  .select('id')
  .eq('user_id', user.id)
  .eq('is_system', false)
  .ilike('name', trimmedName)
  .maybeSingle();

if (existing) {
  return {
    data: null,
    error: new Error('An exercise with this name already exists'),
  };
}
```

Then update the INSERT block to use `trimmedName` (it already does `name.trim()` on line 123, but use the pre-computed variable for consistency).

Also fix `exerciseExists()` (lines 189-211): change `.eq('name', name.trim())` to `.ilike('name', name.trim())` so the helper is also case-insensitive. This function is not currently called during create, but fixing it prevents future bugs if someone uses it.
  </action>
  <verify>
Run `npx tsc --noEmit` from the packages/shared directory to confirm no type errors. Visually inspect the code to confirm:
1. createExercise has .ilike() check before INSERT
2. exerciseExists uses .ilike() instead of .eq()
3. The existing updateExercise .ilike() pattern is preserved (no regressions)
  </verify>
  <done>createExercise rejects case-variant duplicates (e.g., "bench press" when "Bench Press" exists) by returning the same error message the 23505 handler would have returned.</done>
</task>

<task type="auto">
  <name>Task 2: Guard SettingsPanel dismiss paths during active creation</name>
  <files>
    apps/web/src/surfaces/dashboard/MyExercisesList.tsx
    apps/web/src/surfaces/dashboard/SettingsPanel.tsx
  </files>
  <action>
The problem: SettingsPanel owns showCreateModal state but has no visibility into isCreating. Three dismiss paths exist; only one (modal overlay click via dismissCreate) is guarded.

Fix approach: Expose isCreating from MyExercisesList to SettingsPanel via a callback prop.

**In MyExercisesList.tsx:**

1. Add `onCreatingChange?: (creating: boolean) => void` to the MyExercisesListProps interface (alongside the existing optional props).

2. Call `onCreatingChange?.(true)` when isCreating becomes true and `onCreatingChange?.(false)` when it becomes false. The simplest way: add a useEffect that watches isCreating:
```typescript
useEffect(() => {
  onCreatingChange?.(isCreating);
}, [isCreating, onCreatingChange]);
```

**In SettingsPanel.tsx:**

1. Add local state: `const [isCreating, setIsCreating] = useState(false);`

2. Pass `onCreatingChange={setIsCreating}` to the MyExercisesList component.

3. Guard `handleBackdropClick`: return early if isCreating is true.
```typescript
const handleBackdropClick = () => {
  if (isCreating) return;
  onClose();
};
```

4. Guard `handleBack`: return early if isCreating is true.
```typescript
const handleBack = () => {
  if (isCreating) return;
  if (panelView === 'exercises') {
    setPanelView('menu');
  } else {
    onClose();
  }
};
```

5. Guard the useEffect cleanup: only reset showCreateModal if NOT isCreating.
```typescript
useEffect(() => {
  if (!isOpen) {
    const timer = setTimeout(() => {
      setPanelView('menu');
      if (!isCreating) {
        setShowCreateModal(false);
      }
    }, 250);
    return () => clearTimeout(timer);
  }
}, [isOpen, isCreating]);
```

Do NOT touch the dismissCreate callback in MyExercisesList -- it already has the correct `if (isCreating) return;` guard.
  </action>
  <verify>
Run `npx tsc --noEmit` from the apps/web directory to confirm no type errors. Visually inspect:
1. MyExercisesList exposes onCreatingChange prop and calls it via useEffect
2. SettingsPanel receives isCreating via callback and guards all three dismiss paths
3. The existing dismissCreate guard in MyExercisesList is unchanged
  </verify>
  <done>
All three dismiss paths (backdrop click, back button, close-animation cleanup) are no-ops when a create operation is in progress. The modal stays open and visible until the save completes or fails.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit` in both packages/shared and apps/web
2. Gap 1 closed: createExercise has .ilike() pre-check; exerciseExists uses .ilike()
3. Gap 2 closed: SettingsPanel guards backdrop, back, and cleanup with isCreating state
4. No regressions: updateExercise duplicate check unchanged, dismissCreate guard unchanged, delete modal flow unchanged
</verification>

<success_criteria>
- Creating an exercise with a case-variant of an existing name returns "An exercise with this name already exists"
- Tapping outside the modal, pressing back, or closing the panel during an active create save does NOT dismiss the modal
- All existing create/edit/delete flows continue to work (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/21-exercise-create/21-02-SUMMARY.md`
</output>
