---
phase: 20-exercise-delete
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sql/migration_cascade_delete.sql
  - sql/current_schema.sql
  - apps/web/css/styles.css
  - apps/web/src/surfaces/dashboard/MyExercisesList.tsx
autonomous: false

must_haves:
  truths:
    - "User can tap a trash icon on any exercise row to initiate delete"
    - "A confirmation modal appears with exercise name and warning about history deletion"
    - "If the exercise is used in templates, an amber warning box appears in the modal"
    - "Confirming delete removes the exercise from the list immediately"
    - "Modal buttons are labeled 'Delete Exercise' and 'Keep Exercise'"
  artifacts:
    - path: "sql/migration_cascade_delete.sql"
      provides: "ON DELETE CASCADE migration for three FK constraints"
      contains: "ON DELETE CASCADE"
    - path: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      provides: "Delete button, confirmation modal, dependency check, state management"
      contains: "deleteExercise"
    - path: "apps/web/css/styles.css"
      provides: "Delete trigger button styles and warning box styles"
      contains: "my-exercises-delete-trigger"
  key_links:
    - from: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      to: "exercises.deleteExercise"
      via: "confirmDelete handler"
      pattern: "exercises\\.deleteExercise"
    - from: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      to: "exercises.getExerciseDependencies"
      via: "handleDeleteClick pre-modal check"
      pattern: "exercises\\.getExerciseDependencies"
---

<objective>
Add exercise delete functionality with confirmation modal and dependency warnings to the My Exercises list.

Purpose: Users need to delete custom exercises they no longer want. The confirmation modal with dependency warnings prevents accidental data loss by informing users when an exercise is used in templates.

Output: Trash icon on each exercise row, confirmation modal with "Delete Exercise?" title, dependency warning for template usage, cascade delete migration for database FK constraints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-exercise-delete/20-CONTEXT.md
@.planning/phases/20-exercise-delete/20-RESEARCH.md
@apps/web/src/surfaces/dashboard/MyExercisesList.tsx
@apps/web/css/styles.css
@packages/shared/src/services/exercises.ts
@sql/current_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cascade delete migration and update schema reference</name>
  <files>
    sql/migration_cascade_delete.sql
    sql/current_schema.sql
  </files>
  <action>
Create `sql/migration_cascade_delete.sql` with ALTER TABLE statements to drop and re-add the three FK constraints with ON DELETE CASCADE:

1. `template_exercises.exercise_id` -> `exercises.id` ON DELETE CASCADE
2. `workout_log_exercises.exercise_id` -> `exercises.id` ON DELETE CASCADE
3. `user_charts.exercise_id` -> `exercises.id` ON DELETE CASCADE

Use the exact constraint names from current_schema.sql:
- `template_exercises_exercise_id_fkey`
- `workout_log_exercises_exercise_id_fkey`
- `user_charts_exercise_id_fkey`

Pattern (for each):
```sql
ALTER TABLE {table} DROP CONSTRAINT {constraint_name};
ALTER TABLE {table} ADD CONSTRAINT {constraint_name}
  FOREIGN KEY (exercise_id) REFERENCES public.exercises(id) ON DELETE CASCADE;
```

Add a header comment with date, purpose (cascade delete for exercise removal), and a note that this must be run in the Supabase SQL editor.

Then update `sql/current_schema.sql` to reflect the new ON DELETE CASCADE on those three FK lines. Append " ON DELETE CASCADE" to each of the three constraint definitions.

Why cascade: The CONTEXT.md message says "All history will be deleted with it." Without CASCADE, deleting an exercise with any references will fail with a PostgreSQL FK violation.
  </action>
  <verify>
Verify migration file exists and contains all three ALTER TABLE DROP + ADD pairs. Verify current_schema.sql shows ON DELETE CASCADE on the three exercise_id FK constraints.
  </verify>
  <done>
Migration SQL file ready to run. Schema reference updated to reflect cascade behavior.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Run cascade delete migration in Supabase</name>
  <action>Run the migration SQL in the Supabase SQL editor</action>
  <instructions>
1. Open your Supabase project dashboard
2. Go to SQL Editor
3. Paste the contents of `sql/migration_cascade_delete.sql`
4. Click "Run"
5. Verify no errors appear
  </instructions>
  <resume-signal>Type "done" after running the migration successfully</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Add delete button, confirmation modal, and dependency warning to MyExercisesList</name>
  <files>
    apps/web/css/styles.css
    apps/web/src/surfaces/dashboard/MyExercisesList.tsx
  </files>
  <action>
**CSS additions** (append to the My Exercises List section in styles.css, after `.my-exercises-row.save-success`):

1. `.my-exercises-delete-trigger` - Matches the edit trigger pattern but with `color: var(--color-danger)`. Same sizing: `min-width: 44px`, `min-height: 44px`, flex centered, `background: none`, `border: none`, `cursor: pointer`, `padding: var(--spacing-xs)`.

2. `.delete-warning-box` - Amber warning box:
   - `background-color: rgba(251, 191, 36, 0.1)`
   - `border: 1px solid var(--color-warning)`
   - `border-radius: var(--radius-md)`
   - `padding: var(--spacing-sm) var(--spacing-md)`
   - `color: var(--color-warning)`
   - `font-size: 0.875rem`
   - `margin-top: var(--spacing-sm)`

**MyExercisesList.tsx modifications:**

1. Add a `TrashIcon` component (local to the file) using the SVG from the research (24 viewBox, 18x18 display size, `stroke="currentColor"`, stroke-width 2, same path as ChartCard's trash icon).

2. Add delete state variables:
   - `showDeleteModal` (boolean, default false)
   - `pendingDeleteId` (string | null, default null)
   - `pendingDeleteName` (string, default '')
   - `hasTemplateDeps` (boolean, default false)
   - `isDeleting` (boolean, default false)

3. Add `handleDeleteClick` callback:
   - Set pendingDeleteId and pendingDeleteName from the clicked exercise
   - Call `exercises.getExerciseDependencies(exercise.id)`
   - Set `hasTemplateDeps` to `data.templateCount > 0` (only check templateCount per CONTEXT.md)
   - Set `showDeleteModal` to true
   - If getExerciseDependencies errors, still show the modal (just without warning)

4. Add `confirmDelete` callback:
   - Guard: if no pendingDeleteId, return
   - Set isDeleting true
   - Call `exercises.deleteExercise(pendingDeleteId)`
   - Set isDeleting false
   - If no error: remove from userExercises state via filter, reset expandedId if it matches the deleted exercise
   - Set showDeleteModal false, reset pending state
   - If error: keep modal open (the user can try again or cancel)

5. Add `dismissDelete` callback:
   - Set showDeleteModal false
   - Reset pendingDeleteId, pendingDeleteName, hasTemplateDeps

6. In the exercise row JSX, add a delete button AFTER the edit trigger button and BEFORE the `.my-exercises-edit-form` div:
   ```tsx
   <button
     type="button"
     class="my-exercises-delete-trigger"
     onClick={() => handleDeleteClick(exercise)}
     aria-label={`Delete ${exercise.name}`}
   >
     <TrashIcon />
   </button>
   ```

7. Add the delete confirmation modal at the END of the component return (after the `.my-exercises-list` div), rendered conditionally when `showDeleteModal` is true:
   - Use existing CSS classes: `modal-overlay`, `modal modal-sm`, `modal-header`, `modal-body`, `modal-footer`
   - Title (in modal-header h2): "Delete Exercise?"
   - Body paragraph: "Delete {pendingDeleteName}. All history will be deleted with it."
   - If `hasTemplateDeps`, render a `div.delete-warning-box` below the paragraph: "This exercise is used in templates."
   - Footer buttons:
     - "Keep Exercise" button: `class="btn btn-secondary"`, onClick dismissDelete, disabled when isDeleting
     - "Delete Exercise" button: `class="btn btn-danger"`, onClick confirmDelete, disabled when isDeleting, text changes to "Deleting..." when isDeleting
   - Overlay click calls dismissDelete (but stopPropagation on inner modal div)

8. Wrap the return in a fragment (`<>...</>`) to include both the exercise list (or empty state) and the modal overlay.

Important: Do NOT modify the existing ConfirmationModal component. Build the modal inline using existing modal CSS classes (this follows the DashboardSurface pattern for custom delete modals).

Important: The `margin-left: auto` on `.my-exercises-edit-trigger` pushes both icon buttons to the right side of the row. The delete trigger does NOT need `margin-left: auto`.
  </action>
  <verify>
1. Run `npx tsc --noEmit` from the `apps/web` directory -- should have no NEW errors (pre-existing path alias errors in other files are known and acceptable)
2. Visually confirm the TrashIcon SVG uses `stroke-linecap="round"` and `stroke-linejoin="round"` attributes (Preact compatibility -- no camelCase for SVG attributes)
3. Check that showDeleteModal state gates the modal overlay rendering
4. Check that confirmDelete filters the exercise from userExercises state
  </verify>
  <done>
Trash icon visible on each exercise row in danger red. Clicking it opens a centered confirmation modal with exercise name, history warning, and optional template dependency warning in amber box. "Delete Exercise" confirms and removes from list. "Keep Exercise" cancels. Double-click prevented via isDeleting state.
  </done>
</task>

</tasks>

<verification>
1. Each exercise row shows pencil (edit) and trash (delete) icons side by side on the right
2. Clicking trash opens a modal: title "Delete Exercise?", body "Delete [Name]. All history will be deleted with it."
3. If exercise has template dependencies, amber warning "This exercise is used in templates." appears below body text
4. "Delete Exercise" (red) confirms, removes exercise from list instantly
5. "Keep Exercise" (secondary) cancels, closes modal
6. Deleting the last exercise transitions to the empty state
7. If the deleted exercise's edit form was expanded, accordion state resets
8. Confirm button shows "Deleting..." and is disabled during the async operation
</verification>

<success_criteria>
- CRUD-07: User can delete an exercise from the exercise row (trash icon always visible)
- CRUD-08: Delete shows confirmation modal before removing
- CRUD-09: Confirmation modal displays template dependency warning when applicable
- CRUD-10: Modal buttons labeled "Delete Exercise" / "Keep Exercise"
- DB cascade ensures exercises with dependencies can actually be deleted
</success_criteria>

<output>
After completion, create `.planning/phases/20-exercise-delete/20-01-SUMMARY.md`
</output>
