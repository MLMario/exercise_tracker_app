---
phase: 09-workout-surface
plan: 05
type: execute
depends_on: ["09-04"]
files_modified: [src/surfaces/workout/WorkoutSurface.tsx, src/components/ConfirmationModal.tsx, src/components/index.ts]
---

<objective>
Implement workout modals (finish, cancel, template update), exercise picker integration, and localStorage backup/restore with multi-tab sync.

Purpose: Complete the workout flow with confirmation dialogs, exercise addition, and state persistence.
Output: Full workout lifecycle with modals, exercise picker, localStorage backup, and multi-tab synchronization.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-workout-surface/09-04-SUMMARY.md

# Existing code to migrate:
@js/app.js (lines 907-1044: finishWorkout flow, saveWorkoutAndCleanup, confirmTemplateUpdate, declineTemplateUpdate, cancelWorkout flow, hasTemplateChanges)
@js/app.js (lines 1294-1420: localStorage backup/restore, multi-tab sync)
@index.html (lines 826-873: workout modals HTML)

# Existing shared component:
@src/components/ExercisePickerModal.tsx

# Current workout surface:
@src/surfaces/workout/WorkoutSurface.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConfirmationModal component</name>
  <files>src/components/ConfirmationModal.tsx, src/components/index.ts</files>
  <action>
Create a reusable ConfirmationModal component for workout dialogs.

**Props interface:**
```typescript
interface ConfirmationModalProps {
  isOpen: boolean;
  title: string;
  message: string;
  /** Optional secondary message (muted text) */
  secondaryMessage?: string;
  /** Label for confirm button */
  confirmLabel: string;
  /** Label for cancel button */
  cancelLabel: string;
  /** Variant for confirm button styling */
  confirmVariant?: 'primary' | 'danger';
  onConfirm: () => void;
  onCancel: () => void;
}
```

**Render (match index.html lines 843-873 modal structure):**
```tsx
export function ConfirmationModal({
  isOpen,
  title,
  message,
  secondaryMessage,
  confirmLabel,
  cancelLabel,
  confirmVariant = 'primary',
  onConfirm,
  onCancel
}: ConfirmationModalProps) {
  if (!isOpen) return null;

  return (
    <div class="modal-overlay" onClick={onCancel}>
      <div class="modal modal-sm" onClick={(e) => e.stopPropagation()}>
        <div class="modal-header">
          <h2>{title}</h2>
        </div>
        <div class="modal-body">
          <p>{message}</p>
          {secondaryMessage && <p class="text-muted">{secondaryMessage}</p>}
        </div>
        <div class="modal-footer">
          <button onClick={onCancel} class="btn btn-secondary">
            {cancelLabel}
          </button>
          <button
            onClick={onConfirm}
            class={`btn btn-${confirmVariant}`}
          >
            {confirmLabel}
          </button>
        </div>
      </div>
    </div>
  );
}
```

**Update src/components/index.ts:**
```typescript
export { ExercisePickerModal } from './ExercisePickerModal';
export { ConfirmationModal } from './ConfirmationModal';
```
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>ConfirmationModal created as reusable component with title, message, buttons</done>
</task>

<task type="auto">
  <name>Task 2: Implement workout modals and finish/cancel flow</name>
  <files>src/surfaces/workout/WorkoutSurface.tsx</files>
  <action>
Add modal state and handlers for workout finish, cancel, and template update flows.

**State (ensure from Plan 01):**
```typescript
const [showFinishWorkoutModal, setShowFinishWorkoutModal] = useState(false);
const [showCancelWorkoutModal, setShowCancelWorkoutModal] = useState(false);
const [showTemplateUpdateModal, setShowTemplateUpdateModal] = useState(false);
const [pendingWorkoutData, setPendingWorkoutData] = useState<WorkoutData | null>(null);
```

**hasTemplateChanges function (js/app.js lines 1046-1087):**
```typescript
const hasTemplateChanges = (): boolean => {
  if (!originalTemplateSnapshot || !activeWorkout.template_id) {
    return false;
  }

  const original = originalTemplateSnapshot.exercises;
  const current = activeWorkout.exercises;

  // Check exercise count
  if (original.length !== current.length) return true;

  // Check each exercise
  for (const currEx of current) {
    const origEx = original.find(e => e.exercise_id === currEx.exercise_id);
    if (!origEx) return true; // New exercise added
    if (origEx.sets.length !== currEx.sets.length) return true; // Set count changed

    // Check set values
    for (let j = 0; j < currEx.sets.length; j++) {
      const origSet = origEx.sets[j];
      const currSet = currEx.sets[j];
      if (!origSet) return true;
      if (origSet.weight !== currSet.weight || origSet.reps !== currSet.reps) {
        return true;
      }
    }
  }

  // Check if any original exercises removed
  for (const origEx of original) {
    if (!current.find(e => e.exercise_id === origEx.exercise_id)) {
      return true;
    }
  }

  return false;
};
```

**Modal handlers (js/app.js lines 907-1044):**

```typescript
// Finish workout - show modal
const handleFinishWorkout = (): void => {
  setError('');
  if (activeWorkout.exercises.length === 0) {
    setError('Add at least one exercise to finish the workout');
    return;
  }
  setShowFinishWorkoutModal(true);
};

// Confirm finish workout
const confirmFinishWorkout = (): void => {
  setShowFinishWorkoutModal(false);

  if (activeWorkout.template_id && hasTemplateChanges()) {
    // Save workout data for after template update decision
    setPendingWorkoutData({
      template_id: activeWorkout.template_id,
      started_at: activeWorkout.started_at!,
      finished_at: new Date().toISOString(),
      exercises: activeWorkout.exercises
    });
    setShowTemplateUpdateModal(true);
    return;
  }

  saveWorkoutAndCleanup();
};

// Save workout and cleanup
const saveWorkoutAndCleanup = async (): Promise<void> => {
  try {
    const workoutData = pendingWorkoutData || {
      template_id: activeWorkout.template_id,
      started_at: activeWorkout.started_at!,
      finished_at: new Date().toISOString(),
      exercises: activeWorkout.exercises
    };

    const { error } = await window.logging.createWorkoutLog(workoutData);
    if (error) throw new Error(error.message);

    // Clear localStorage backup
    clearWorkoutFromStorage();

    // Reset state and navigate back
    stopTimer();
    onFinish?.();
  } catch (err) {
    setError('Failed to save workout: ' + (err instanceof Error ? err.message : String(err)));
  }
};

// Template update modal handlers
const confirmTemplateUpdate = async (): Promise<void> => {
  try {
    const templateExercises = activeWorkout.exercises.map(ex => ({
      exercise_id: ex.exercise_id,
      name: ex.name,
      category: ex.category,
      default_rest_seconds: ex.rest_seconds,
      sets: ex.sets.map(set => ({
        set_number: set.set_number,
        weight: set.weight,
        reps: set.reps
      }))
    }));

    const { error } = await window.templates.updateTemplate(
      activeWorkout.template_id!,
      activeWorkout.template_name,
      templateExercises
    );

    if (error) {
      setError('Failed to update template: ' + error.message);
    }
  } catch (err) {
    setError('Failed to update template: ' + (err instanceof Error ? err.message : String(err)));
  }

  setShowTemplateUpdateModal(false);
  await saveWorkoutAndCleanup();
};

const declineTemplateUpdate = (): void => {
  setShowTemplateUpdateModal(false);
  saveWorkoutAndCleanup();
};

// Cancel workout handlers
const handleCancelWorkout = (): void => {
  setShowCancelWorkoutModal(true);
};

const confirmCancelWorkout = (): void => {
  setShowCancelWorkoutModal(false);
  stopTimer();
  clearWorkoutFromStorage();
  onCancel?.();
};
```

**Render modals:**
```tsx
{/* Finish Workout Modal */}
<ConfirmationModal
  isOpen={showFinishWorkoutModal}
  title="Finish Workout?"
  message="Save this workout and end your session?"
  confirmLabel="Save"
  cancelLabel="Cancel"
  confirmVariant="primary"
  onConfirm={confirmFinishWorkout}
  onCancel={() => setShowFinishWorkoutModal(false)}
/>

{/* Cancel Workout Modal */}
<ConfirmationModal
  isOpen={showCancelWorkoutModal}
  title="Cancel Workout?"
  message="All progress will be lost. This cannot be undone."
  confirmLabel="Discard"
  cancelLabel="Go Back"
  confirmVariant="danger"
  onConfirm={confirmCancelWorkout}
  onCancel={() => setShowCancelWorkoutModal(false)}
/>

{/* Template Update Modal */}
<ConfirmationModal
  isOpen={showTemplateUpdateModal}
  title="Update Template?"
  message="You made changes during this workout. Update the template with these changes?"
  secondaryMessage="This will update exercises, sets, weights, and reps."
  confirmLabel="Yes, Update"
  cancelLabel="No, Keep Original"
  confirmVariant="primary"
  onConfirm={confirmTemplateUpdate}
  onCancel={declineTemplateUpdate}
/>
```
  </action>
  <verify>npm run build succeeds, finish/cancel modals appear and work correctly</verify>
  <done>Workout modals implemented with finish, cancel, template update flows</done>
</task>

<task type="auto">
  <name>Task 3: Add exercise picker and localStorage backup</name>
  <files>src/surfaces/workout/WorkoutSurface.tsx</files>
  <action>
Integrate ExercisePickerModal and implement localStorage backup/restore with multi-tab sync.

**Exercise picker state and handlers:**
```typescript
const [showExercisePicker, setShowExercisePicker] = useState(false);
const [availableExercises, setAvailableExercises] = useState<Exercise[]>([]);

// Load exercises for picker
useEffect(() => {
  const loadExercises = async () => {
    const { data } = await window.exercises.getExercises();
    setAvailableExercises(data || []);
  };
  loadExercises();
}, []);

const handleOpenExercisePicker = (): void => {
  setShowExercisePicker(true);
};

const handleSelectExercise = (exercise: Exercise): void => {
  // Check if exercise already in workout
  const exists = activeWorkout.exercises.some(ex => ex.exercise_id === exercise.id);
  if (exists) {
    setError('Exercise already in workout');
    return;
  }

  // Add exercise with default sets
  setActiveWorkout(prev => ({
    ...prev,
    exercises: [...prev.exercises, {
      exercise_id: exercise.id,
      name: exercise.name,
      category: exercise.category,
      order: prev.exercises.length,
      rest_seconds: 90,
      sets: [
        { set_number: 1, weight: 0, reps: 10, is_done: false },
        { set_number: 2, weight: 0, reps: 10, is_done: false },
        { set_number: 3, weight: 0, reps: 10, is_done: false }
      ]
    }]
  }));

  setShowExercisePicker(false);
};

const handleCreateExercise = async (name: string, category: string): Promise<void> => {
  const { data, error } = await window.exercises.createExercise(name, category);
  if (error) {
    throw new Error(error.message);
  }
  if (data) {
    // Refresh exercises list
    const { data: exercises } = await window.exercises.getExercises();
    setAvailableExercises(exercises || []);
    // Select the newly created exercise
    handleSelectExercise(data);
  }
};
```

**LocalStorage backup/restore (js/app.js lines 1294-1420):**
```typescript
// Storage key for current user
const getWorkoutStorageKey = (): string | null => {
  // We need to get user ID - for now use template_id based key
  return activeWorkout.template_id ? `activeWorkout_${activeWorkout.template_id}` : null;
};

const saveWorkoutToStorage = (): void => {
  const key = getWorkoutStorageKey();
  if (!key || !activeWorkout.started_at || activeWorkout.exercises.length === 0) return;

  const backupData = {
    activeWorkout,
    originalTemplateSnapshot,
    last_saved_at: new Date().toISOString()
  };

  localStorage.setItem(key, JSON.stringify(backupData));
};

const clearWorkoutFromStorage = (): void => {
  const key = getWorkoutStorageKey();
  if (key) {
    localStorage.removeItem(key);
  }
};

// Save to localStorage on workout changes
useEffect(() => {
  if (activeWorkout.started_at) {
    saveWorkoutToStorage();
  }
}, [activeWorkout]);

// Multi-tab sync listener
useEffect(() => {
  const handleStorageChange = (event: StorageEvent): void => {
    const key = getWorkoutStorageKey();
    if (event.key !== key) return;

    if (event.newValue === null) {
      // Workout was cleared in another tab - navigate back
      onCancel?.();
    } else {
      // Workout updated in another tab - sync it
      try {
        const backupData = JSON.parse(event.newValue);
        if (backupData.activeWorkout) {
          setActiveWorkout(backupData.activeWorkout);
          setOriginalTemplateSnapshot(backupData.originalTemplateSnapshot);
        }
      } catch (e) {
        // Ignore parse errors
      }
    }
  };

  window.addEventListener('storage', handleStorageChange);
  return () => window.removeEventListener('storage', handleStorageChange);
}, [activeWorkout.template_id]);
```

**Render exercise picker:**
```tsx
<ExercisePickerModal
  isOpen={showExercisePicker}
  exercises={availableExercises}
  onClose={() => setShowExercisePicker(false)}
  onSelectExercise={handleSelectExercise}
  onCreateExercise={handleCreateExercise}
/>
```

**Update "Add Exercise" button:**
```tsx
<div class="workout-footer">
  <button onClick={handleOpenExercisePicker} class="btn btn-primary btn-block">
    Add Exercise
  </button>
</div>
```
  </action>
  <verify>npm run build succeeds, can add exercises to workout, localStorage backup works, multi-tab sync works</verify>
  <done>Exercise picker integrated, localStorage backup with multi-tab sync implemented, Phase 9 complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] Finish workout modal appears when clicking Finish
- [ ] Cancel workout modal appears when clicking Cancel
- [ ] Template update modal appears when workout has changes
- [ ] Saving workout calls logging service and navigates back
- [ ] Can add exercises via ExercisePickerModal
- [ ] Workout state persists to localStorage
- [ ] Changes sync across browser tabs
- [ ] Phase 9: Workout Surface complete
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Full workout lifecycle functional
- Modals work correctly with appropriate flows
- Exercise addition works
- LocalStorage backup and multi-tab sync operational
- No TypeScript errors
- Phase 9 complete
</success_criteria>

<output>
After completion, create `.planning/phases/09-workout-surface/09-05-SUMMARY.md`
</output>
