---
phase: 07-dashboard-surface
plan: 03
type: execute
depends_on: ["07-01"]
files_modified: [src/surfaces/dashboard/ChartSection.tsx, src/surfaces/dashboard/ChartCard.tsx, src/surfaces/dashboard/AddChartModal.tsx, src/surfaces/dashboard/DashboardSurface.tsx]
---

<objective>
Create charts section components with Chart.js rendering and add chart modal.

Purpose: Display user's progress charts and allow adding/removing charts.
Output: ChartSection, ChartCard, and AddChartModal components integrated into DashboardSurface.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan output:
@.planning/phases/07-dashboard-surface/07-01-SUMMARY.md

# Source patterns:
@src/surfaces/auth/LoginForm.tsx
@src/surfaces/dashboard/DashboardSurface.tsx

# Existing app.js chart methods (lines 381-439, 1196-1283):
# - loadUserCharts(), renderAllCharts(), destroyAllCharts()
# - openAddChartModal(), closeAddChartModal(), createChart()
# - removeChart(id), confirmDeleteChart(), dismissDeleteChartModal()
@js/app.js

# Chart-related types:
@src/types/domain.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChartSection and ChartCard components with Chart.js rendering</name>
  <files>src/surfaces/dashboard/ChartSection.tsx, src/surfaces/dashboard/ChartCard.tsx</files>
  <action>
**Create ChartCard.tsx:**

Props interface (ChartCardProps):
- chart: UserChart
- chartInstance: Chart | null (the rendered Chart.js instance)
- onDelete: (id: string) => void

Render:
- Card container with chart title (exercise name + metric type)
- Canvas element with id={`chart-${chart.id}`} for Chart.js rendering
- Delete button (X icon or trash)
- Loading indicator when chartInstance is null

**Create ChartSection.tsx:**

Props interface (ChartSectionProps):
- charts: UserChart[]
- chartInstances: Record<string, Chart>
- onAddChart: () => void
- onDeleteChart: (id: string) => void
- onRenderCharts: () => Promise<void> (callback to trigger chart rendering)

Render:
- Section header "Progress Charts" with "Add Chart" button
- Empty state message when charts.length === 0
- Grid/flex layout for chart cards
- Map charts to ChartCard components

**useEffect for chart rendering:**
- Call onRenderCharts() when charts array changes
- This triggers parent to call Chart.js render

**Pattern notes:**
- Chart.js rendering happens in parent (DashboardSurface)
- ChartCard just provides the canvas element
- Use useEffect to trigger rendering after DOM update
  </action>
  <verify>npx tsc --noEmit passes, both component files exist with proper interfaces</verify>
  <done>ChartSection.tsx and ChartCard.tsx exist with props and render logic</done>
</task>

<task type="auto">
  <name>Task 2: Create AddChartModal and integrate chart functionality</name>
  <files>src/surfaces/dashboard/AddChartModal.tsx, src/surfaces/dashboard/DashboardSurface.tsx</files>
  <action>
**Create AddChartModal.tsx:**

Props interface (AddChartModalProps):
- isOpen: boolean
- exercises: Exercise[]
- onClose: () => void
- onSubmit: (exerciseId: string, metricType: string, xAxisMode: string) => void
- error: string

Internal state:
- selectedExerciseId: string
- selectedMetricType: string
- selectedXAxisMode: string

Metric type options: 'max_weight', 'max_volume_set', 'total_sets'
X-axis mode options: 'date', 'session'

Render:
- Modal overlay (click outside to close)
- Modal content with form:
  - Exercise dropdown (from exercises prop)
  - Metric type dropdown
  - X-axis mode dropdown
  - Cancel and Submit buttons
- Error message display

**Update DashboardSurface:**

1. **Add chart-related state:**
   - chartInstances: Record<string, Chart> - store Chart.js instances
   - showAddChartModal: boolean
   - showDeleteChartModal: boolean
   - pendingDeleteChartId: string | null

2. **loadUserCharts():**
   - Fetch charts from window.charts.getUserCharts()
   - Set userCharts state
   - Matches js/app.js lines 381-392

3. **renderAllCharts():**
   - Destroy existing chart instances first
   - Loop through userCharts
   - For each chart, get canvas element by id
   - Call window.logging.getExerciseMetrics() for data
   - Call window.charts.renderChart() to create instance
   - Store in chartInstances state
   - Matches js/app.js lines 394-431

4. **destroyAllCharts():**
   - Loop through chartInstances
   - Call chart.destroy() on each
   - Clear chartInstances
   - Matches js/app.js lines 433-440

5. **Modal handlers:**
   - openAddChartModal(), closeAddChartModal()
   - handleCreateChart(exerciseId, metricType, xAxisMode)
   - handleDeleteChart(id), confirmDeleteChart(), dismissDeleteChartModal()
   - Matches js/app.js lines 1198-1283

6. **Update useEffect:**
   - Call loadUserCharts() after loadDashboard
   - Add chart rendering after DOM update

7. **Update render:**
   - Import and render ChartSection with props
   - Import and render AddChartModal conditionally
   - Add delete confirmation modal (simple confirm for now)

**Pattern notes:**
- Chart.js instances must be destroyed before re-rendering
- Canvas elements need to exist in DOM before Chart.js can render
- Use setTimeout or $nextTick equivalent to ensure DOM is ready
  </action>
  <verify>npm run build succeeds, charts section renders, add chart modal works, delete works</verify>
  <done>Full chart functionality working - display, add, delete, Chart.js rendering</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] ChartSection.tsx exists with proper props interface
- [ ] ChartCard.tsx exists with canvas element for Chart.js
- [ ] AddChartModal.tsx exists with form and submit
- [ ] DashboardSurface loads and renders charts with Chart.js
- [ ] Add chart modal opens/closes and creates charts
- [ ] Delete chart confirmation and deletion works
- [ ] Chart instances properly destroyed on component unmount
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Charts display with real Chart.js rendering
- Add and delete chart workflows complete
- Phase 7 complete: Dashboard surface fully migrated to Preact
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-surface/07-03-SUMMARY.md`
</output>
