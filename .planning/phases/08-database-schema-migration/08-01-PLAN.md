---
phase: 08-database-schema-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sql/migration_system_exercises.sql
  - sql/current_schema.sql
autonomous: true

must_haves:
  truths:
    - "exercises.user_id column allows NULL values"
    - "is_system, instructions, level, force, mechanic columns exist"
    - "RLS SELECT policy returns user exercises + system exercises"
    - "RLS INSERT/UPDATE/DELETE policies restrict to user's own non-system exercises"
    - "Indexes exist for system exercise lookup and user_id filtering"
  artifacts:
    - path: "sql/migration_system_exercises.sql"
      provides: "Complete migration for system exercises support"
      contains: "ALTER TABLE public.exercises"
    - path: "sql/current_schema.sql"
      provides: "Updated schema reference document"
      contains: "is_system boolean"
  key_links:
    - from: "sql/migration_system_exercises.sql"
      to: "Supabase SQL Editor"
      via: "Manual execution by user"
      pattern: "Run in Supabase SQL Editor"
---

<objective>
Create database migration for system exercises support.

Purpose: Enable the exercises table to store both user-created exercises (user_id set) and system/pre-created exercises (user_id NULL, is_system=true). Update RLS policies to allow all authenticated users to read system exercises while restricting writes to user's own non-system exercises.

Output: Migration SQL file ready for execution in Supabase SQL Editor.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-database-schema-migration/08-CONTEXT.md
@.planning/phases/08-database-schema-migration/08-RESEARCH.md
@sql/migration_template_sets.sql
@sql/current_schema.sql
@pre_created_exercise_list_proposal.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration file for system exercises</name>
  <files>sql/migration_system_exercises.sql</files>
  <action>
Create migration file following the established project pattern (see migration_template_sets.sql).

**Header:**
- Migration: System Exercises Support
- Description: Enables pre-created exercise library with ~800 system exercises
- Date: current date
- Note: Run in Supabase SQL Editor

**STEP 1: Alter exercises table schema**
- `ALTER TABLE public.exercises ALTER COLUMN user_id DROP NOT NULL;`
- Add columns in single ALTER statement:
  - `instructions text[]` (nullable)
  - `level text CHECK (level = ANY (ARRAY['beginner', 'intermediate', 'expert']))` (nullable)
  - `force text CHECK (force = ANY (ARRAY['push', 'pull', 'static']))` (nullable)
  - `mechanic text CHECK (mechanic = ANY (ARRAY['compound', 'isolation']))` (nullable)
  - `is_system boolean NOT NULL DEFAULT false`
- Update category CHECK constraint to include 'Other':
  ```sql
  ALTER TABLE public.exercises DROP CONSTRAINT IF EXISTS exercises_category_check;
  ALTER TABLE public.exercises ADD CONSTRAINT exercises_category_check
    CHECK (category = ANY (ARRAY['Chest', 'Back', 'Shoulders', 'Legs', 'Arms', 'Core', 'Other']));
  ```

**STEP 2: Enable RLS and create policies**
- `ALTER TABLE public.exercises ENABLE ROW LEVEL SECURITY;`
- Drop any existing policies (DROP POLICY IF EXISTS for common names like exercises_user_policy, exercises_select_policy, etc.)
- Create 4 policies using `(SELECT auth.uid())` pattern and `TO authenticated` clause:

1. SELECT policy (exercises_select_policy):
   ```sql
   CREATE POLICY exercises_select_policy ON public.exercises
     FOR SELECT
     TO authenticated
     USING (
       user_id = (SELECT auth.uid())
       OR is_system = true
     );
   ```

2. INSERT policy (exercises_insert_policy):
   ```sql
   CREATE POLICY exercises_insert_policy ON public.exercises
     FOR INSERT
     TO authenticated
     WITH CHECK (
       user_id = (SELECT auth.uid())
       AND is_system = false
     );
   ```

3. UPDATE policy (exercises_update_policy):
   ```sql
   CREATE POLICY exercises_update_policy ON public.exercises
     FOR UPDATE
     TO authenticated
     USING (
       user_id = (SELECT auth.uid())
       AND is_system = false
     );
   ```

4. DELETE policy (exercises_delete_policy):
   ```sql
   CREATE POLICY exercises_delete_policy ON public.exercises
     FOR DELETE
     TO authenticated
     USING (
       user_id = (SELECT auth.uid())
       AND is_system = false
     );
   ```

**STEP 3: Create indexes**
- Partial index for system exercises: `CREATE INDEX idx_exercises_system ON public.exercises (id) WHERE is_system = true;`
- Index on user_id: `CREATE INDEX idx_exercises_user_id ON public.exercises (user_id);`

**VERIFICATION QUERIES section:**
Add commented-out queries to verify:
- Table columns exist: `SELECT column_name FROM information_schema.columns WHERE table_name = 'exercises';`
- RLS is enabled: `SELECT relname, relrowsecurity FROM pg_class WHERE relname = 'exercises';`
- Policies exist: `SELECT policyname FROM pg_policies WHERE tablename = 'exercises';`
- Indexes exist: `SELECT indexname FROM pg_indexes WHERE tablename = 'exercises';`
- Category constraint includes 'Other': `SELECT consrc FROM pg_constraint WHERE conname = 'exercises_category_check';`

**ROLLBACK section:**
Add commented-out rollback statements:
- DROP policies
- DROP indexes
- Remove columns
- Re-add NOT NULL to user_id
- Restore original category constraint
  </action>
  <verify>File exists and contains all required SQL statements: ALTER TABLE, 4 CREATE POLICY statements, 2 CREATE INDEX statements, VERIFICATION QUERIES section, ROLLBACK section.</verify>
  <done>Migration file sql/migration_system_exercises.sql ready for user to execute in Supabase SQL Editor.</done>
</task>

<task type="auto">
  <name>Task 2: Update current_schema.sql reference document</name>
  <files>sql/current_schema.sql</files>
  <action>
Update the exercises table definition in current_schema.sql to reflect the new schema.

The exercises table should show:
```sql
CREATE TABLE public.exercises (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,  -- Now nullable for system exercises
  name text NOT NULL,
  category text NOT NULL CHECK (category = ANY (ARRAY['Chest'::text, 'Back'::text, 'Shoulders'::text, 'Legs'::text, 'Arms'::text, 'Core'::text, 'Other'::text])),
  equipment text,
  instructions text[],
  level text CHECK (level = ANY (ARRAY['beginner'::text, 'intermediate'::text, 'expert'::text])),
  force text CHECK (force = ANY (ARRAY['push'::text, 'pull'::text, 'static'::text])),
  mechanic text CHECK (mechanic = ANY (ARRAY['compound'::text, 'isolation'::text])),
  is_system boolean NOT NULL DEFAULT false,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT exercises_pkey PRIMARY KEY (id),
  CONSTRAINT exercises_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
```

Keep the WARNING comment at the top of the file.
Keep all other tables unchanged.
  </action>
  <verify>Read current_schema.sql and confirm exercises table shows: nullable user_id, is_system column, instructions/level/force/mechanic columns, updated category constraint with 'Other'.</verify>
  <done>current_schema.sql reflects the new exercises table schema for future reference.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. sql/migration_system_exercises.sql exists with complete migration
2. sql/current_schema.sql updated with new exercises schema
3. Migration file follows project conventions (STEPs, verification, rollback sections)
4. All 9 SCHEMA requirements addressed (SCHEMA-01 through SCHEMA-09)
5. All 5 RLS requirements addressed (RLS-01 through RLS-05)
</verification>

<success_criteria>
- Migration file created with schema changes, RLS policies, and indexes
- Uses (SELECT auth.uid()) optimization pattern per RLS-05
- Uses TO authenticated clause per research best practices
- Category constraint includes 'Other' per SCHEMA-07
- current_schema.sql updated as reference documentation
- Files ready for user to run migration in Supabase SQL Editor
</success_criteria>

<output>
After completion, create `.planning/phases/08-database-schema-migration/08-01-SUMMARY.md`
</output>
