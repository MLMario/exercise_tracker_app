---
phase: 05-data-services
plan: 03
type: execute
depends_on: []
files_modified: [src/services/logging.ts, src/services/index.ts]
---

<objective>
Migrate logging service from js/logging.js to TypeScript with full type safety.

Purpose: Enable type-safe workout logging and exercise metrics calculation.
Output: Working logging service with backward compatibility via window.logging export.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-auth-service/04-01-SUMMARY.md

# Type definitions already exist:
@src/types/database.ts
@src/types/services.ts

# Pattern to follow:
@src/services/auth.ts

# Source to migrate:
@js/logging.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logging service module</name>
  <files>src/services/logging.ts</files>
  <action>
Create TypeScript implementation of LoggingService interface from src/types/services.ts.

Implement all 6 functions with exact behavioral parity to js/logging.js:

1. createWorkoutLog(data: WorkoutLogInput) - Create workout_log, then iterate exercises to insert workout_log_exercises with rest_seconds and order, then insert workout_log_sets for each. Include rollback on failure.

   NOTE: The original JS supports both object and separate params. The TS interface uses only WorkoutLogInput object format. This is a behavioral simplification that's acceptable since we're migrating, not wrapping.

2. getWorkoutLogs(limit = 52) - Fetch workout logs with exercise count using Supabase's count aggregation syntax: `workout_log_exercises (count)`. Transform to WorkoutLogSummary[] format.

3. getWorkoutLog(id) - Fetch single workout log with nested workout_log_exercises, exercises, and workout_log_sets. Sort by order and set_number in memory. Return WorkoutLogWithExercises format.

4. getExerciseHistory(exerciseId, options) - Complex query that:
   - Fetches workout_log_exercises with workout_logs (inner join) and workout_log_sets
   - Sorts by started_at in memory (Supabase doesn't support ordering by nested columns)
   - Calculates metrics: totalSets (completed sets), maxWeight, maxVolumeSet (weight * reps or just reps for bodyweight)
   - Groups by date or session based on mode
   - Returns ExerciseHistoryData[] (union type based on mode)

5. getExerciseMetrics(exerciseId, options) - Wrapper around getExerciseHistory that transforms to ChartData format:
   - Reverse data for oldest-to-newest order
   - Extract labels (dates or "Session N")
   - Extract values based on metric type (total_sets or max_volume_set)

6. getRecentExerciseData(exerciseId) - Fetch most recent workout data for an exercise to pre-fill defaults. Return RecentExerciseData | null.

Metrics calculation helper (internal):
```typescript
function calculateMetrics(exercises: WorkoutLogExerciseWithSets[]) {
  let totalSets = 0, maxWeight = 0, maxVolumeSet = 0;
  // Iterate sets, filter completed (is_done), track max values
  // Volume = weight > 0 ? weight * reps : reps (bodyweight)
  return { totalSets, maxWeight, maxVolumeSet };
}
```

Follow auth.ts patterns:
- Import types from @/types/services and @/types/database
- Import supabase from @/lib/supabase
- Use try/catch with console.error logging
- Return ServiceResult<T> or null (for getRecentExerciseData)
- Export as `logging` object implementing LoggingService
- Add window.logging export for backward compatibility

AVOID: Don't change the metrics calculation logic - the volume formula (weight > 0 ? weight * reps : reps) is intentional for bodyweight exercises. The in-memory sorting is necessary because Supabase can't order by nested columns.
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>All 6 functions implemented with exact behavioral parity to js/logging.js, including metrics calculations</done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export and verify build</name>
  <files>src/services/index.ts</files>
  <action>
Add logging service to the barrel export:
- Export { logging } from './logging'
- Also export the LoggingService type from the module

Verify the complete build succeeds.
  </action>
  <verify>npm run build succeeds without errors or warnings</verify>
  <done>Logging service exported via barrel, build passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] All 6 LoggingService interface methods implemented
- [ ] Metrics calculations match js/logging.js exactly
- [ ] Date and session grouping modes work correctly
- [ ] window.logging backward compatibility export present
- [ ] No behavioral changes from js/logging.js
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Logging service matches LoggingService interface
- Exercise history and metrics calculations preserve exact behavior
- Backward compatible with existing js/app.js usage
- Phase 5 complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-services/05-03-SUMMARY.md`
</output>
