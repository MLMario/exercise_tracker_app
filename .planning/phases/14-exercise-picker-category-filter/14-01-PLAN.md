---
phase: 14-exercise-picker-category-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/hooks/useClickOutside.ts
  - apps/web/src/hooks/index.ts
  - apps/web/src/components/ExercisePickerModal.tsx
  - apps/web/css/styles.css
autonomous: true

must_haves:
  truths:
    - "User sees category dropdown above search input when Exercise Picker opens"
    - "User can select a category to filter exercises to that category only"
    - "User can type in search to filter by name (not category text)"
    - "Category and search filters work together (combined filtering)"
    - "Category resets to 'All Categories' when modal reopens"
    - "Dropdown menu closes when clicking outside"
  artifacts:
    - path: "apps/web/src/hooks/useClickOutside.ts"
      provides: "Click outside detection hook"
      exports: ["useClickOutside"]
    - path: "apps/web/src/components/ExercisePickerModal.tsx"
      provides: "Category dropdown UI and combined filter logic"
      contains: "selectedCategory"
    - path: "apps/web/css/styles.css"
      provides: "Category dropdown styling"
      contains: ".category-dropdown"
  key_links:
    - from: "ExercisePickerModal.tsx"
      to: "useClickOutside"
      via: "import from hooks"
      pattern: "import.*useClickOutside.*from.*hooks"
    - from: "ExercisePickerModal.tsx"
      to: "filteredExercises"
      via: "useMemo with selectedCategory dependency"
      pattern: "useMemo.*selectedCategory"
---

<objective>
Add category filter dropdown to Exercise Picker Modal that works alongside the existing search input.

Purpose: Users can filter exercises by category (Chest, Back, Shoulders, Legs, Arms, Core, Other) before or in combination with text search, making exercise discovery faster in large exercise libraries.

Output: Working category dropdown in Exercise Picker Modal with combined filtering behavior.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-exercise-picker-category-filter/14-CONTEXT.md
@.planning/phases/14-exercise-picker-category-filter/14-RESEARCH.md
@apps/web/src/components/ExercisePickerModal.tsx
@apps/web/src/hooks/index.ts
@apps/web/css/styles.css
@packages/shared/src/types/database.ts (for ExerciseCategory type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useClickOutside hook</name>
  <files>
    apps/web/src/hooks/useClickOutside.ts
    apps/web/src/hooks/index.ts
  </files>
  <action>
Create a reusable hook for detecting clicks outside a referenced element.

1. Create `apps/web/src/hooks/useClickOutside.ts`:

```typescript
import { useEffect, RefObject, useCallback } from 'preact/hooks';

export function useClickOutside(
  ref: RefObject<HTMLElement>,
  handler: () => void
): void {
  const stableHandler = useCallback(handler, [handler]);

  useEffect(() => {
    const handleClick = (event: MouseEvent | TouchEvent) => {
      if (ref.current && !ref.current.contains(event.target as Node)) {
        stableHandler();
      }
    };

    document.addEventListener('mousedown', handleClick);
    document.addEventListener('touchstart', handleClick);

    return () => {
      document.removeEventListener('mousedown', handleClick);
      document.removeEventListener('touchstart', handleClick);
    };
  }, [ref, stableHandler]);
}
```

2. Update `apps/web/src/hooks/index.ts` to export the new hook:
```typescript
export { useAsyncOperation } from './useAsyncOperation';
export { useClickOutside } from './useClickOutside';
```

Key details:
- Use `mousedown` and `touchstart` (not `click`) so dropdown closes before any click action completes
- Handle both mouse and touch events for mobile support
- Use `useCallback` to stabilize handler reference
  </action>
  <verify>
TypeScript compiles without errors: `npm run build --workspace=apps/web`
  </verify>
  <done>useClickOutside hook exists and is exported from hooks index</done>
</task>

<task type="auto">
  <name>Task 2: Add category dropdown to ExercisePickerModal</name>
  <files>
    apps/web/src/components/ExercisePickerModal.tsx
  </files>
  <action>
Modify ExercisePickerModal to add category dropdown filter above search input.

1. Add imports at top of file:
```typescript
import { useState, useMemo, useEffect, useRef, useCallback } from 'preact/hooks';
import type { ExerciseCategory } from '@ironlift/shared';
import { useAsyncOperation, useClickOutside } from '@/hooks';
```

2. Define filter category options AFTER the existing CATEGORY_OPTIONS:
```typescript
const FILTER_CATEGORIES: readonly ('All Categories' | ExerciseCategory)[] = [
  'All Categories',
  'Chest',
  'Back',
  'Shoulders',
  'Legs',
  'Arms',
  'Core',
  'Other',
] as const;
```
Note: Use 7 categories from ExerciseCategory type (no Cardio), NOT the 8 from CATEGORY_OPTIONS.

3. Add state for category filter after existing state declarations:
```typescript
const [selectedCategory, setSelectedCategory] = useState<'All Categories' | ExerciseCategory>('All Categories');
const [isDropdownOpen, setIsDropdownOpen] = useState(false);
const dropdownRef = useRef<HTMLDivElement>(null);
```

4. Add useClickOutside hook after state:
```typescript
const closeDropdown = useCallback(() => setIsDropdownOpen(false), []);
useClickOutside(dropdownRef, closeDropdown);
```

5. Update the modal-open reset useEffect (around line 84) to reset category:
```typescript
useEffect(() => {
  if (isOpen) {
    setSearchQuery('');
    setSelectedCategory('All Categories');  // ADD THIS LINE
    setIsDropdownOpen(false);               // ADD THIS LINE
    setShowNewExerciseForm(false);
    setNewExerciseName('');
    setNewExerciseCategory('');
    resetAsync();
  }
}, [isOpen, resetAsync]);
```

6. Update filteredExercises useMemo (around line 99) to:
   - Filter by category FIRST (if not "All Categories")
   - Filter by name ONLY (remove the category text search per PICK-01)
```typescript
const filteredExercises = useMemo(() => {
  let result = exercises;

  // Filter by category first (if not "All Categories")
  if (selectedCategory !== 'All Categories') {
    result = result.filter((ex) => ex.category === selectedCategory);
  }

  // Filter by search query - NAME ONLY (not category, per PICK-01)
  if (searchQuery) {
    const query = searchQuery.toLowerCase();
    result = result.filter((ex) => ex.name.toLowerCase().includes(query));
  }

  // Sort: user exercises first (is_system=false), then alphabetically
  return [...result].sort((a, b) => {
    if (a.is_system !== b.is_system) {
      return a.is_system ? 1 : -1;
    }
    return a.name.localeCompare(b.name);
  });
}, [exercises, selectedCategory, searchQuery]);
```

7. Add dropdown handler:
```typescript
const handleCategorySelect = (category: 'All Categories' | ExerciseCategory): void => {
  setSelectedCategory(category);
  setIsDropdownOpen(false);
};
```

8. In the modal-body, ADD the category dropdown BEFORE the search input form-group:
```tsx
{/* Category filter dropdown - PICK-02: above search input */}
<div class="category-dropdown-wrapper">
  <div class="category-dropdown" ref={dropdownRef}>
    <button
      type="button"
      class="dropdown-trigger"
      onClick={() => setIsDropdownOpen(!isDropdownOpen)}
      aria-expanded={isDropdownOpen}
      aria-haspopup="listbox"
    >
      <span>{selectedCategory}</span>
      <svg
        class={`dropdown-chevron ${isDropdownOpen ? 'open' : ''}`}
        width="12"
        height="12"
        viewBox="0 0 12 12"
        fill="currentColor"
      >
        <path d="M6 9L1 4h10z" />
      </svg>
    </button>
    {isDropdownOpen && (
      <ul class="dropdown-menu" role="listbox">
        {FILTER_CATEGORIES.map((category) => (
          <li
            key={category}
            role="option"
            aria-selected={category === selectedCategory}
            class={category === selectedCategory ? 'selected' : ''}
            onClick={() => handleCategorySelect(category)}
          >
            {category}
          </li>
        ))}
      </ul>
    )}
  </div>
</div>
```

9. Update the empty state message to be simpler per CONTEXT.md:
```tsx
{filteredExercises.length === 0 && !showNewExerciseForm && (
  <div class="empty-state">
    <p>No exercises found</p>
  </div>
)}
```
  </action>
  <verify>
TypeScript compiles: `npm run build --workspace=apps/web`
  </verify>
  <done>ExercisePickerModal has category dropdown state, combined filter logic, and dropdown UI above search input</done>
</task>

<task type="auto">
  <name>Task 3: Add dropdown CSS styling</name>
  <files>
    apps/web/css/styles.css
  </files>
  <action>
Add CSS for the category dropdown to match the existing input styling.

Add the following CSS after the existing modal styles (search for "Exercise Picker Modal" section or add near end of file):

```css
/* ==========================================================================
   Category Dropdown (Exercise Picker)
   ========================================================================== */
.category-dropdown-wrapper {
  margin-bottom: var(--spacing-md);
}

.category-dropdown {
  position: relative;
  width: 180px; /* Partial width per CONTEXT.md */
}

.dropdown-trigger {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: var(--spacing-sm);
  width: 100%;
  padding: 0.75rem var(--spacing-md);
  background-color: var(--color-bg-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  color: var(--color-text-primary);
  font-size: 1rem;
  font-family: var(--font-family);
  cursor: pointer;
  min-height: var(--min-tap-target);
  transition: border-color var(--transition-fast);
}

.dropdown-trigger:hover {
  border-color: var(--color-text-secondary);
}

.dropdown-trigger:focus {
  outline: none;
  border-color: var(--color-accent);
  box-shadow: 0 0 0 3px rgba(79, 158, 255, 0.1);
}

.dropdown-chevron {
  color: var(--color-text-secondary);
  transition: transform var(--transition-fast);
  flex-shrink: 0;
}

.dropdown-chevron.open {
  transform: rotate(180deg);
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  margin-top: var(--spacing-xs);
  padding: var(--spacing-xs) 0;
  background-color: var(--color-bg-elevated);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  list-style: none;
  z-index: 100;
  max-height: 300px;
  overflow-y: auto;
}

.dropdown-menu li {
  padding: 0.75rem var(--spacing-md);
  cursor: pointer;
  color: var(--color-text-primary);
  transition: background-color var(--transition-fast);
  min-height: var(--min-tap-target);
  display: flex;
  align-items: center;
}

.dropdown-menu li:hover {
  background-color: var(--color-bg-surface);
}

.dropdown-menu li.selected {
  background-color: rgba(79, 158, 255, 0.15);
  color: var(--color-accent);
}
```

Key styling decisions:
- Width: 180px (partial width, left-aligned per CONTEXT.md)
- Matches input styling: same padding, border radius, colors, min-height
- Overlay menu with z-index: 100 (floats over content, doesn't push)
- Uses existing CSS variables for consistency
- Transition on chevron rotation per CONTEXT.md discretion
  </action>
  <verify>
Manual: Run dev server (`npm run dev`) and visually verify dropdown matches search input styling, opens as overlay, closes on outside click.
  </verify>
  <done>Dropdown styling matches input, appears as overlay, menu items have hover/selection states</done>
</task>

</tasks>

<verification>
After all tasks complete, verify requirements coverage:

1. **PICK-01**: Search input filters by name only
   - Test: Type "chest" in search with "All Categories" selected
   - Expected: Only exercises with "chest" in NAME appear (not exercises in Chest category)

2. **PICK-02**: Category dropdown above search input
   - Visual check: Dropdown renders above the search input

3. **PICK-03**: Default "All Categories"
   - Test: Open modal, check dropdown shows "All Categories"

4. **PICK-04**: All 7 categories listed
   - Test: Click dropdown, verify shows: Chest, Back, Shoulders, Legs, Arms, Core, Other

5. **PICK-05**: Category selection filters list
   - Test: Select "Chest", verify only chest exercises shown

6. **PICK-06**: Combined filtering
   - Test: Select "Chest" + type "press", verify only chest exercises containing "press"

7. **Reset on reopen**: Close and reopen modal, category should reset to "All Categories"

8. **Click outside**: Click outside dropdown menu closes it
</verification>

<success_criteria>
- [ ] Category dropdown appears above search input in Exercise Picker Modal
- [ ] Dropdown defaults to "All Categories" each time modal opens
- [ ] Selecting a category instantly filters the exercise list
- [ ] Search filters by exercise name only (not category text)
- [ ] Category and search filters combine correctly
- [ ] Dropdown closes when clicking outside
- [ ] Dropdown styling matches the search input (colors, radius, tap targets)
- [ ] TypeScript compiles without errors
- [ ] All 6 PICK requirements verified
</success_criteria>

<output>
After completion, create `.planning/phases/14-exercise-picker-category-filter/14-01-SUMMARY.md`
</output>
