---
phase: 22-history-navigation-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/surfaces/dashboard/SettingsPanel.tsx
  - apps/web/src/surfaces/dashboard/SettingsMenu.tsx
  - packages/shared/src/services/logging.ts
  - packages/shared/src/types/services.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User sees 'Workout History' menu item in Settings panel"
    - "User can tap 'Workout History' to see placeholder view"
    - "User can navigate back from history placeholder to Settings menu"
  artifacts:
    - path: "apps/web/src/surfaces/dashboard/SettingsMenu.tsx"
      provides: "Workout History menu item with Calendar icon"
      contains: "Workout History"
    - path: "apps/web/src/surfaces/dashboard/SettingsPanel.tsx"
      provides: "history panelView state and placeholder render"
      contains: "panelView === 'history'"
    - path: "packages/shared/src/services/logging.ts"
      provides: "Paginated history service functions"
      exports: ["getWorkoutLogsPaginated", "getWorkoutSummaryStats"]
    - path: "packages/shared/src/types/services.ts"
      provides: "TypeScript interfaces for history data"
      contains: "WorkoutHistoryItem"
  key_links:
    - from: "SettingsMenu"
      to: "SettingsPanel"
      via: "onWorkoutHistory callback"
      pattern: "onWorkoutHistory"
    - from: "SettingsPanel"
      to: "panelView state"
      via: "setPanelView('history')"
      pattern: "setPanelView.*history"
---

<objective>
Add "Workout History" menu item to Settings panel with navigation to placeholder view, plus backend service functions for paginated workout history retrieval.

Purpose: Enable user access to workout history feature (NAV-01) and prepare data layer for Phase 23 list UI.
Output: Working navigation path Settings -> Workout History (placeholder), plus `getWorkoutLogsPaginated`, `getWorkoutLogDetail` (reuse existing), and `getWorkoutSummaryStats` service functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-history-navigation-service/22-CONTEXT.md
@.planning/phases/22-history-navigation-service/22-RESEARCH.md
@.planning/phases/17-settings-surface-shell/17-01-SUMMARY.md

# Source files
@apps/web/src/surfaces/dashboard/SettingsPanel.tsx
@apps/web/src/surfaces/dashboard/SettingsMenu.tsx
@packages/shared/src/services/logging.ts
@packages/shared/src/types/services.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Workout History navigation to Settings panel</name>
  <files>
    apps/web/src/surfaces/dashboard/SettingsMenu.tsx
    apps/web/src/surfaces/dashboard/SettingsPanel.tsx
  </files>
  <action>
**SettingsMenu.tsx:**
1. Add `onWorkoutHistory` prop to `SettingsMenuProps` interface
2. Add "Workout History" menu item between "My Exercises" and "Log Out" button:
   - Use existing `.settings-menu-item` structure (icon + label + chevron)
   - Calendar icon SVG (outline style, 20x20):
     ```tsx
     <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
       <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
       <line x1="16" y1="2" x2="16" y2="6"></line>
       <line x1="8" y1="2" x2="8" y2="6"></line>
       <line x1="3" y1="10" x2="21" y2="10"></line>
     </svg>
     ```
   - Label: "Workout History"
   - onClick: `onWorkoutHistory`

**SettingsPanel.tsx:**
1. Extend `PanelView` type: `'menu' | 'exercises' | 'history'`
2. Update `headerTitle` conditional:
   ```tsx
   const headerTitle =
     panelView === 'menu' ? 'Settings' :
     panelView === 'exercises' ? 'My Exercises' :
     'Workout History';
   ```
3. Update `handleBack` to include history:
   ```tsx
   if (panelView === 'exercises' || panelView === 'history') {
     setPanelView('menu');
   }
   ```
4. Pass `onWorkoutHistory={() => setPanelView('history')}` to SettingsMenu
5. Add render for `panelView === 'history'`:
   ```tsx
   {panelView === 'history' && (
     <div class="history-placeholder" style={{ padding: '2rem', textAlign: 'center' }}>
       <p style={{ color: 'var(--color-text-muted)' }}>History view coming soon</p>
     </div>
   )}
   ```
  </action>
  <verify>
Run `npm run check` from monorepo root to verify TypeScript compiles without errors.
  </verify>
  <done>
- "Workout History" menu item appears in Settings menu after "My Exercises"
- Tapping opens placeholder view with "History view coming soon" message
- Back arrow returns to Settings menu
- Header shows "Workout History" when in history view
  </done>
</task>

<task type="auto">
  <name>Task 2: Add paginated history service functions</name>
  <files>
    packages/shared/src/types/services.ts
    packages/shared/src/services/logging.ts
  </files>
  <action>
**types/services.ts - Add new interfaces (after LoggingService section, before Charts section):**
```typescript
/**
 * Summary data for workout history list item.
 * Extended from WorkoutLogSummary with additional computed fields.
 */
export interface WorkoutHistoryItem {
  /** Workout log UUID */
  id: string;
  /** Source template UUID (null for ad-hoc workouts) */
  template_id: string | null;
  /** Template name (null if template was deleted or ad-hoc) */
  template_name: string | null;
  /** ISO timestamp when workout started */
  started_at: string;
  /** Number of exercises in this workout */
  exercise_count: number;
  /** Number of completed sets across all exercises */
  completed_sets: number;
  /** Total volume in lbs (SUM of weight * reps for completed sets) */
  total_volume: number;
}

/**
 * Paginated result wrapper for list endpoints.
 */
export interface PaginatedResult<T> {
  /** Array of items for current page */
  data: T[];
  /** Whether more items exist beyond this page */
  hasMore: boolean;
}

/**
 * All-time workout summary statistics.
 */
export interface WorkoutSummaryStats {
  /** Total number of logged workouts */
  totalWorkouts: number;
  /** Total completed sets across all workouts */
  totalSets: number;
  /** Total volume in lbs across all workouts */
  totalVolume: number;
}
```

**types/services.ts - Extend LoggingService interface (add after getRecentExerciseData):**
```typescript
/**
 * Get paginated workout history for list view.
 *
 * @param offset - Number of items to skip
 * @param limit - Number of items to return
 * @returns Promise resolving to paginated history items or error
 */
getWorkoutLogsPaginated(
  offset: number,
  limit: number
): Promise<ServiceResult<PaginatedResult<WorkoutHistoryItem>>>;

/**
 * Get all-time workout summary statistics.
 *
 * @returns Promise resolving to summary stats or error
 */
getWorkoutSummaryStats(): Promise<ServiceResult<WorkoutSummaryStats>>;
```

**logging.ts - Add getWorkoutLogsPaginated function (after getWorkoutLog):**
```typescript
/**
 * Get paginated workout history for list view.
 * Returns summary info per workout including template name, completed sets, and total volume.
 *
 * @param offset - Number of items to skip
 * @param limit - Number of items to return (page size)
 * @returns Promise resolving to paginated history items or error
 */
async function getWorkoutLogsPaginated(
  offset: number,
  limit: number
): Promise<ServiceResult<PaginatedResult<WorkoutHistoryItem>>> {
  try {
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return {
        data: null,
        error: authError || new Error('User not authenticated'),
      };
    }

    // Fetch workout logs with template name and nested sets for aggregation
    const { data, error, count } = await supabase
      .from('workout_logs')
      .select(`
        id,
        template_id,
        started_at,
        templates (name),
        workout_log_exercises (
          workout_log_sets (
            weight,
            reps,
            is_done
          )
        )
      `, { count: 'exact' })
      .eq('user_id', user.id)
      .order('started_at', { ascending: false })
      .range(offset, offset + limit - 1);  // Supabase range is inclusive

    if (error) {
      return { data: null, error };
    }

    // Transform to WorkoutHistoryItem with computed fields
    const items: WorkoutHistoryItem[] = (data || []).map((log: any) => {
      let completedSets = 0;
      let totalVolume = 0;
      let exerciseCount = 0;

      if (log.workout_log_exercises) {
        exerciseCount = log.workout_log_exercises.length;
        log.workout_log_exercises.forEach((ex: any) => {
          if (ex.workout_log_sets) {
            ex.workout_log_sets.forEach((set: any) => {
              if (set.is_done) {
                completedSets++;
                totalVolume += (set.weight || 0) * (set.reps || 0);
              }
            });
          }
        });
      }

      return {
        id: log.id,
        template_id: log.template_id,
        template_name: log.templates?.name || null,
        started_at: log.started_at,
        exercise_count: exerciseCount,
        completed_sets: completedSets,
        total_volume: totalVolume,
      };
    });

    const hasMore = count !== null && count > offset + items.length;

    return {
      data: { data: items, hasMore },
      error: null,
    };
  } catch (err) {
    console.error('Get workout logs paginated error:', err);
    return {
      data: null,
      error: err instanceof Error ? err : new Error(String(err)),
    };
  }
}
```

**logging.ts - Add getWorkoutSummaryStats function:**
```typescript
/**
 * Get all-time workout summary statistics.
 * Returns total workouts, total completed sets, and total volume.
 *
 * @returns Promise resolving to summary stats or error
 */
async function getWorkoutSummaryStats(): Promise<ServiceResult<WorkoutSummaryStats>> {
  try {
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      return {
        data: null,
        error: authError || new Error('User not authenticated'),
      };
    }

    // Get total workout count
    const { count: workoutCount, error: countError } = await supabase
      .from('workout_logs')
      .select('id', { count: 'exact', head: true })
      .eq('user_id', user.id);

    if (countError) {
      return { data: null, error: countError };
    }

    // Get all sets for aggregation
    const { data: exercisesData, error: exercisesError } = await supabase
      .from('workout_log_exercises')
      .select(`
        workout_log_sets (
          weight,
          reps,
          is_done
        ),
        workout_logs!inner (
          user_id
        )
      `)
      .eq('workout_logs.user_id', user.id);

    if (exercisesError) {
      return { data: null, error: exercisesError };
    }

    // Calculate totals from completed sets
    let totalSets = 0;
    let totalVolume = 0;

    (exercisesData || []).forEach((ex: any) => {
      if (ex.workout_log_sets) {
        ex.workout_log_sets.forEach((set: any) => {
          if (set.is_done) {
            totalSets++;
            totalVolume += (set.weight || 0) * (set.reps || 0);
          }
        });
      }
    });

    return {
      data: {
        totalWorkouts: workoutCount || 0,
        totalSets,
        totalVolume,
      },
      error: null,
    };
  } catch (err) {
    console.error('Get workout summary stats error:', err);
    return {
      data: null,
      error: err instanceof Error ? err : new Error(String(err)),
    };
  }
}
```

**logging.ts - Update imports and exports:**
1. Add imports for new types at top:
   ```typescript
   import type {
     // ... existing imports ...
     WorkoutHistoryItem,
     PaginatedResult,
     WorkoutSummaryStats,
   } from '../types/services';
   ```
2. Add new functions to logging export object:
   ```typescript
   export const logging: LoggingService = {
     createWorkoutLog,
     getWorkoutLogs,
     getWorkoutLog,
     getExerciseHistory,
     getExerciseMetrics,
     getRecentExerciseData,
     getWorkoutLogsPaginated,     // NEW
     getWorkoutSummaryStats,      // NEW
   };
   ```

**Note on getWorkoutLogDetail:** Per RESEARCH.md, the existing `getWorkoutLog(id)` function already provides full workout details with exercises and sets. Phase 24 will use this existing function. No new `getWorkoutLogDetail` function needed.
  </action>
  <verify>
Run `npm run check` from monorepo root to verify TypeScript compiles and types are consistent.
  </verify>
  <done>
- `WorkoutHistoryItem`, `PaginatedResult<T>`, `WorkoutSummaryStats` types exist in services.ts
- `getWorkoutLogsPaginated(offset, limit)` function exists in logging.ts
- `getWorkoutSummaryStats()` function exists in logging.ts
- Both functions exported via `logging` object
- LoggingService interface includes both new methods
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes with no TypeScript errors
2. Settings panel shows "Workout History" menu item after "My Exercises"
3. Tapping "Workout History" shows placeholder with "History view coming soon"
4. Back navigation from history returns to Settings menu
5. Header shows "Workout History" title when in history view
</verification>

<success_criteria>
- NAV-01 requirement satisfied (user can access "Workout History" from Settings)
- Backend service layer ready for Phase 23 consumption
- Zero TypeScript errors
- Existing Settings panel functionality unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/22-history-navigation-service/22-01-SUMMARY.md`
</output>
