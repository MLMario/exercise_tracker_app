---
phase: 09-workout-surface
plan: 03
type: execute
depends_on: ["09-02"]
files_modified: [src/surfaces/workout/RestTimerBar.tsx, src/surfaces/workout/WorkoutSurface.tsx, src/surfaces/workout/WorkoutExerciseCard.tsx]
---

<objective>
Implement rest timer functionality with per-exercise countdown and controls.

Purpose: Enable automatic rest countdown between sets with visual feedback and adjustment controls.
Output: RestTimerBar component with timer state management integrated into workout flow.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-workout-surface/09-02-SUMMARY.md

# Existing timer service:
@js/timer.js

# Existing code to migrate:
@js/app.js (lines 1089-1194: startRestTimer, stopTimer, adjustTimer, isTimerActiveForExercise, getTimerProgress, formatTime)
@index.html (lines 619-636: rest timer bar HTML structure)

# Current workout surface:
@src/surfaces/workout/WorkoutSurface.tsx
@src/surfaces/workout/WorkoutExerciseCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RestTimerBar component</name>
  <files>src/surfaces/workout/RestTimerBar.tsx</files>
  <action>
Create RestTimerBar.tsx as a presentational component for the rest timer display.

**Props interface:**
```typescript
interface RestTimerBarProps {
  /** Current displayed time in seconds */
  displaySeconds: number;
  /** Timer progress percentage (100 = full, 0 = empty) */
  progress: number;
  /** Whether timer is actively running for this exercise */
  isActive: boolean;
  /** Whether timer completed (seconds reached 0) */
  isComplete: boolean;
  /** Callback to adjust timer by delta seconds */
  onAdjust: (deltaSeconds: number) => void;
}
```

**Render (match index.html lines 619-636):**
```tsx
<div class="rest-timer-bar-container">
  <div class="rest-timer-bar-wrapper">
    <div
      class={`rest-timer-bar-fill ${
        !isActive ? 'idle' :
        !isComplete ? 'running' : 'complete'
      }`}
      style={{ width: `${progress}%` }}
    />
    <span class="rest-timer-bar-time">{formatTime(displaySeconds)}</span>
  </div>
  <div class="rest-timer-controls">
    <button class="btn-timer-adjust" onClick={() => onAdjust(-10)}>-10s</button>
    <button class="btn-timer-adjust" onClick={() => onAdjust(10)}>+10s</button>
  </div>
</div>
```

**formatTime utility (copy from WorkoutSurface or import):**
```typescript
function formatTime(seconds: number): string {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}
```

CSS classes match existing styles in the app (idle/running/complete states).
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>RestTimerBar.tsx created with progress bar, time display, +/-10s controls</done>
</task>

<task type="auto">
  <name>Task 2: Add timer state management to WorkoutSurface</name>
  <files>src/surfaces/workout/WorkoutSurface.tsx</files>
  <action>
Add timer state and handlers to WorkoutSurface (from js/app.js lines 1089-1173).

**State (already declared in Plan 01, ensure implemented):**
```typescript
const [timerSeconds, setTimerSeconds] = useState(0);
const [timerTotalSeconds, setTimerTotalSeconds] = useState(0);
const [timerActive, setTimerActive] = useState(false);
const [activeTimerExerciseIndex, setActiveTimerExerciseIndex] = useState<number | null>(null);

// Ref to store interval ID
const timerIntervalRef = useRef<number | null>(null);
```

**Timer handlers:**

```typescript
// Start rest timer (js/app.js lines 1091-1124)
const startRestTimer = (seconds: number, exIndex: number): void => {
  if (!seconds || seconds <= 0) return;

  // Stop any existing timer first
  stopTimer();

  setTimerActive(true);
  setTimerSeconds(seconds);
  setTimerTotalSeconds(seconds);
  setActiveTimerExerciseIndex(exIndex);

  // Start countdown
  timerIntervalRef.current = window.setInterval(() => {
    setTimerSeconds(prev => {
      if (prev <= 1) {
        // Timer complete
        stopTimer();
        // Could add notification here if needed
        return 0;
      }
      return prev - 1;
    });
  }, 1000);
};

// Stop timer (js/app.js lines 1126-1136)
const stopTimer = (): void => {
  if (timerIntervalRef.current) {
    clearInterval(timerIntervalRef.current);
    timerIntervalRef.current = null;
  }
  setTimerActive(false);
  setTimerSeconds(0);
  setTimerTotalSeconds(0);
  setActiveTimerExerciseIndex(null);
};

// Adjust timer (js/app.js lines 1142-1157)
const adjustTimer = (deltaSeconds: number, exIndex: number): void => {
  if (isTimerActiveForExercise(exIndex)) {
    // Timer is running - adjust running timer
    setTimerSeconds(prev => Math.max(0, prev + deltaSeconds));
    setTimerTotalSeconds(prev => Math.max(0, prev + deltaSeconds));
  } else {
    // Timer is idle - adjust exercise's default rest_seconds
    setActiveWorkout(prev => {
      const updated = { ...prev };
      const exercise = updated.exercises[exIndex];
      if (exercise) {
        exercise.rest_seconds = Math.max(0, exercise.rest_seconds + deltaSeconds);
      }
      return updated;
    });
  }
};

// Check if timer active for exercise (js/app.js lines 1160-1162)
const isTimerActiveForExercise = (exIndex: number): boolean => {
  return timerActive && activeTimerExerciseIndex === exIndex;
};

// Get timer progress (js/app.js lines 1165-1173)
const getTimerProgress = (exIndex: number): number => {
  if (!isTimerActiveForExercise(exIndex)) {
    return 100; // Full bar when idle
  }
  if (timerTotalSeconds <= 0) {
    return 0;
  }
  return Math.round((timerSeconds / timerTotalSeconds) * 100);
};
```

**Update handleToggleDone:**
When set is marked done, start rest timer:
```typescript
const handleToggleDone = (exerciseIndex: number, setIndex: number, restSeconds: number): void => {
  setActiveWorkout(prev => {
    const updated = { ...prev };
    const set = updated.exercises[exerciseIndex].sets[setIndex];
    set.is_done = !set.is_done;
    return updated;
  });

  // Start rest timer when marking set as done
  const exercise = activeWorkout.exercises[exerciseIndex];
  const set = exercise.sets[setIndex];
  if (!set.is_done) { // Will be toggled to done
    startRestTimer(restSeconds, exerciseIndex);
  }
};
```

**Update handleRemoveExercise:**
Stop timer if removing exercise that has active timer:
```typescript
const handleRemoveExercise = (index: number): void => {
  if (activeTimerExerciseIndex === index) {
    stopTimer();
  }
  // Adjust activeTimerExerciseIndex if needed
  if (activeTimerExerciseIndex !== null && index < activeTimerExerciseIndex) {
    setActiveTimerExerciseIndex(prev => prev !== null ? prev - 1 : null);
  }
  setActiveWorkout(prev => ({
    ...prev,
    exercises: prev.exercises.filter((_, i) => i !== index)
  }));
};
```

**Cleanup on unmount:**
```typescript
useEffect(() => {
  return () => {
    if (timerIntervalRef.current) {
      clearInterval(timerIntervalRef.current);
    }
  };
}, []);
```
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>Timer state and handlers implemented in WorkoutSurface, starts on set done, stops on cleanup</done>
</task>

<task type="auto">
  <name>Task 3: Integrate RestTimerBar into WorkoutExerciseCard</name>
  <files>src/surfaces/workout/WorkoutExerciseCard.tsx, src/surfaces/workout/WorkoutSurface.tsx</files>
  <action>
Replace timer placeholder with RestTimerBar component.

**Update WorkoutExerciseCard props:**
```typescript
interface WorkoutExerciseCardProps {
  // ... existing props ...
  // Timer props (now required):
  timerSeconds: number;
  timerProgress: number;
  isTimerActive: boolean;
  onAdjustTimer: (deltaSeconds: number) => void;
}
```

**Update WorkoutExerciseCard render:**
Replace timer placeholder with:
```tsx
<RestTimerBar
  displaySeconds={isTimerActive ? timerSeconds : exercise.rest_seconds}
  progress={timerProgress}
  isActive={isTimerActive}
  isComplete={isTimerActive && timerSeconds === 0}
  onAdjust={onAdjustTimer}
/>
```

**Update WorkoutSurface to pass timer props:**
For each exercise card, compute and pass:
- timerSeconds: isTimerActiveForExercise(i) ? timerSeconds : exercise.rest_seconds
- timerProgress: getTimerProgress(i)
- isTimerActive: isTimerActiveForExercise(i)
- onAdjustTimer: (delta) => adjustTimer(delta, i)
  </action>
  <verify>npm run build succeeds, timer starts when marking set done, progress bar animates, +/-10s buttons work</verify>
  <done>RestTimerBar integrated, timer countdown works, progress bar shows, controls adjust time</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] Timer starts automatically when marking a set as done
- [ ] Timer progress bar animates correctly (fills to empty as time decreases)
- [ ] +10s button adds time to running timer
- [ ] -10s button removes time from running timer
- [ ] When timer idle, +/-10s adjusts exercise's default rest time
- [ ] Removing exercise stops its timer if active
- [ ] Timer cleans up on component unmount
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Rest timer functional with visual feedback
- Timer controls work for both active and idle states
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-workout-surface/09-03-SUMMARY.md`
</output>
