---
phase: 09-data-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - scripts/import-exercises.ts
  - output/system-exercises.csv
autonomous: true

must_haves:
  truths:
    - "Script fetches ~800 exercises from free-exercise-db GitHub repo"
    - "Each exercise is mapped to one of the app's 7 categories"
    - "Generated CSV has all required columns for Supabase import"
    - "All exercises in CSV have is_system=true and user_id empty"
  artifacts:
    - path: "scripts/import-exercises.ts"
      provides: "Data import script"
      min_lines: 100
    - path: "output/system-exercises.csv"
      provides: "CSV ready for Supabase import"
      contains: "name,category,equipment,instructions,level,force,mechanic,is_system,user_id"
  key_links:
    - from: "scripts/import-exercises.ts"
      to: "https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/dist/exercises.json"
      via: "fetch call"
      pattern: "free-exercise-db.*exercises\\.json"
    - from: "scripts/import-exercises.ts"
      to: "output/system-exercises.csv"
      via: "fs.writeFileSync"
      pattern: "writeFileSync.*system-exercises\\.csv"
---

<objective>
Create a TypeScript script to fetch exercise data from free-exercise-db, transform it to match the app's schema, and generate a CSV file for Supabase import.

Purpose: Populate the exercises table with ~800 system exercises that all users can see
Output: `output/system-exercises.csv` ready for Supabase Table Editor import
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-data-import/09-RESEARCH.md
@.planning/phases/08-database-schema-migration/08-01-SUMMARY.md
@sql/current_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set up script infrastructure and implement data import</name>
  <files>package.json, scripts/import-exercises.ts</files>
  <action>
1. Add tsx as dev dependency to root package.json:
   ```bash
   pnpm add -D tsx
   ```

2. Create scripts/ directory and scripts/import-exercises.ts

3. Implement the complete script with:

   **Types:**
   ```typescript
   interface GithubExercise {
     id: string;
     name: string;
     force: string | null;
     level: string;
     mechanic: string | null;
     equipment: string | null;
     primaryMuscles: string[];
     secondaryMuscles: string[];
     instructions: string[];
     category: string;
     images: string[];
   }

   interface AppExercise {
     name: string;
     category: string;
     equipment: string | null;
     instructions: string[];
     level: string | null;
     force: string | null;
     mechanic: string | null;
     is_system: boolean;
     user_id: null;
   }
   ```

   **Muscle-to-Category mapping (from research):**
   - chest -> Chest
   - lats, lower back, middle back, traps -> Back
   - shoulders -> Shoulders
   - quadriceps, hamstrings, calves, glutes, adductors, abductors -> Legs
   - biceps, triceps, forearms -> Arms
   - abdominals -> Core
   - neck, unmapped -> Other

   **Functions to implement:**
   - `fetchExercises()`: Use native fetch to get JSON from `https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/dist/exercises.json`
   - `mapExercise(gh: GithubExercise): AppExercise`: Transform using muscle mapping
   - `escapeArrayElement(value: string): string`: Escape for PostgreSQL array format (backslashes, quotes)
   - `formatPostgresArray(arr: string[]): string`: Format as `{element1,element2}`
   - `escapeCsvField(value: string | null): string`: Escape commas, quotes, newlines
   - `generateCsv(exercises: AppExercise[]): string`: Create CSV string with header row
   - `main()`: Orchestrate fetch -> map -> CSV generation -> file write

   **CSV columns (exact order for Supabase import):**
   `name,category,equipment,instructions,level,force,mechanic,is_system,user_id`

   **Important details:**
   - Replace newlines in instruction strings with spaces (avoid CSV parsing issues)
   - Empty user_id field represents NULL in Supabase CSV import
   - is_system should be literal string "true"
   - Output to `output/system-exercises.csv` (create output/ directory)
   - Log statistics: total exercises, exercises per category

4. Add npm script to root package.json:
   ```json
   "import-exercises": "tsx scripts/import-exercises.ts"
   ```
  </action>
  <verify>
- `pnpm tsx --version` shows tsx is installed
- `scripts/import-exercises.ts` exists and compiles: `pnpm tsc --noEmit scripts/import-exercises.ts` (or no TS errors visible)
  </verify>
  <done>Script file exists with complete implementation including fetch, transform, and CSV generation logic</done>
</task>

<task type="auto">
  <name>Task 2: Run script and validate CSV output</name>
  <files>output/system-exercises.csv</files>
  <action>
1. Run the import script:
   ```bash
   pnpm import-exercises
   ```

2. Validate the output:
   - Check output/system-exercises.csv exists
   - Verify row count is ~800+ exercises (head and wc -l)
   - Verify header row has correct columns
   - Spot check a few rows for correct formatting:
     - PostgreSQL array format for instructions: `{...}`
     - is_system column shows "true"
     - user_id column is empty
     - Categories are one of: Chest, Back, Shoulders, Legs, Arms, Core, Other

3. Log output should show:
   - Total exercises fetched
   - Exercises per category breakdown
   - Output file path

4. If any issues:
   - Check for exercises with missing primaryMuscles (should map to Other)
   - Check for special characters in exercise names or instructions
   - Verify no duplicate exercise names
  </action>
  <verify>
- `output/system-exercises.csv` exists
- First line is header: `name,category,equipment,instructions,level,force,mechanic,is_system,user_id`
- Row count > 800 (excluding header)
- Sample rows have valid PostgreSQL array format for instructions
- No row has user_id populated (should all be empty)
  </verify>
  <done>CSV file generated with ~800+ exercises, correct schema, ready for Supabase import</done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Script runs without errors:**
   ```bash
   pnpm import-exercises
   ```

2. **CSV format validation:**
   - Header: `name,category,equipment,instructions,level,force,mechanic,is_system,user_id`
   - ~800+ data rows
   - Instructions column uses PostgreSQL array format `{...}`
   - is_system column is "true" for all rows
   - user_id column is empty for all rows

3. **Category distribution check:**
   Script output should show exercises distributed across all 7 categories (Chest, Back, Shoulders, Legs, Arms, Core, Other)

4. **Sample row inspection:**
   Pick 3 random rows and verify:
   - name is non-empty
   - category is valid
   - instructions array is properly formatted
</verification>

<success_criteria>
- DATA-01: Script fetches from https://raw.githubusercontent.com/yuhonas/free-exercise-db/main/dist/exercises.json
- DATA-02: Each exercise mapped to Chest/Back/Shoulders/Legs/Arms/Core/Other based on primaryMuscles
- DATA-03: CSV file at output/system-exercises.csv with all columns matching schema
- DATA-04: All rows have is_system=true and user_id=empty(NULL)
</success_criteria>

<output>
After completion, create `.planning/phases/09-data-import/09-01-SUMMARY.md`
</output>
