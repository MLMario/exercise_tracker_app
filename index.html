<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FitTrack - Personal Fitness Tracker</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div x-data="fitnessApp" x-init="init()" class="app">

    <!-- Loading Screen -->
    <div x-show="isLoading" class="loading-screen">
      <div class="loading-content">
        <h2>Loading...</h2>
      </div>
    </div>

    <!-- Auth Surface -->
    <div x-show="!isLoading && currentSurface === 'auth'" class="auth-wrapper">
      <!-- Brand -->
      <div class="brand">
        <h1 class="brand-title">FitTrack</h1>
        <p class="brand-subtitle">Your Personal Fitness Tracker</p>
      </div>

      <!-- Auth Card -->
      <div class="auth-card">
        <!-- Tabs for Login/Register (hidden on reset and updatePassword surfaces) -->
        <div class="auth-tabs" x-show="authSurface !== 'reset' && authSurface !== 'updatePassword'">
          <button
            class="auth-tab"
            :class="{ 'active': authSurface === 'login' }"
            @click="switchAuthSurface('login')">
            Login
          </button>
          <button
            class="auth-tab"
            :class="{ 'active': authSurface === 'register' }"
            @click="switchAuthSurface('register')">
            Register
          </button>
        </div>

        <!-- Surfaces Container -->
        <div class="surfaces-container">

          <!-- LOGIN SURFACE -->
          <div class="auth-surface" :class="{ 'active': authSurface === 'login' }">
            <form @submit.prevent="handleAuth">
              <!-- Error Message -->
              <div x-show="error && authSurface === 'login'" class="error-message" x-text="error"></div>

              <div class="form-group">
                <label for="login-email">Email</label>
                <input
                  type="email"
                  id="login-email"
                  class="input"
                  x-model="authEmail"
                  placeholder="you@example.com"
                  required>
              </div>

              <div class="form-group">
                <label for="login-password">Password</label>
                <div class="input-wrapper">
                  <input
                    :type="showLoginPassword ? 'text' : 'password'"
                    id="login-password"
                    class="input has-toggle"
                    x-model="authPassword"
                    placeholder="Enter your password"
                    required
                    minlength="6">
                  <button type="button" class="password-toggle" @click="togglePasswordVisibility('login')">
                    <svg x-show="!showLoginPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    <svg x-show="showLoginPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                  </button>
                </div>
              </div>

              <a href="#" class="forgot-link" @click.prevent="switchAuthSurface('reset')">Forgot password?</a>

              <button
                type="submit"
                class="btn btn-primary btn-block btn-submit"
                :class="{ 'loading': authLoading }"
                :disabled="authLoading">
                <span x-text="authLoading ? 'Logging in...' : 'Login'"></span>
              </button>
            </form>
          </div>

          <!-- REGISTER SURFACE -->
          <div class="auth-surface" :class="{ 'active': authSurface === 'register' }">
            <form @submit.prevent="handleAuth">
              <!-- Error Message -->
              <div x-show="error && authSurface === 'register'" class="error-message" x-text="error"></div>

              <div class="form-group">
                <label for="register-email">Email</label>
                <input
                  type="email"
                  id="register-email"
                  class="input"
                  x-model="authEmail"
                  placeholder="you@example.com"
                  required>
              </div>

              <div class="form-group">
                <label for="register-password">Password</label>
                <div class="input-wrapper">
                  <input
                    :type="showRegisterPassword ? 'text' : 'password'"
                    id="register-password"
                    class="input has-toggle"
                    x-model="authPassword"
                    placeholder="Create a password"
                    required
                    minlength="6">
                  <button type="button" class="password-toggle" @click="togglePasswordVisibility('register')">
                    <svg x-show="!showRegisterPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    <svg x-show="showRegisterPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                  </button>
                </div>
                <p class="password-hint">Minimum 6 characters</p>
              </div>

              <div class="form-group">
                <label for="register-confirm">Confirm Password</label>
                <div class="input-wrapper">
                  <input
                    :type="showConfirmPassword ? 'text' : 'password'"
                    id="register-confirm"
                    class="input has-toggle"
                    x-model="authConfirmPassword"
                    placeholder="Confirm your password"
                    required
                    minlength="6">
                  <button type="button" class="password-toggle" @click="togglePasswordVisibility('confirm')">
                    <svg x-show="!showConfirmPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    <svg x-show="showConfirmPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                  </button>
                </div>
              </div>

              <button
                type="submit"
                class="btn btn-primary btn-block btn-submit"
                :class="{ 'loading': authLoading }"
                :disabled="authLoading">
                <span x-text="authLoading ? 'Creating account...' : 'Create Account'"></span>
              </button>
            </form>
          </div>

          <!-- RESET PASSWORD SURFACE -->
          <div class="auth-surface" :class="{ 'active': authSurface === 'reset' }">
            <a href="#" class="back-link" @click.prevent="switchAuthSurface('login')">
              <span>←</span> Back to login
            </a>

            <h2 style="margin-bottom: 0.5rem; font-size: 1.25rem;">Reset Password</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem; font-size: 0.875rem;">
              Enter your email and we'll send you a link to reset your password.
            </p>

            <form @submit.prevent="handlePasswordReset">
              <!-- Success Message -->
              <div x-show="resetEmailSent" class="success-message">
                Check your email for reset instructions.
              </div>

              <!-- Error Message -->
              <div x-show="error && authSurface === 'reset'" class="error-message" x-text="error"></div>

              <div class="form-group" x-show="!resetEmailSent">
                <label for="reset-email">Email</label>
                <input
                  type="email"
                  id="reset-email"
                  class="input"
                  x-model="authEmail"
                  placeholder="you@example.com"
                  required>
              </div>

              <button
                x-show="!resetEmailSent"
                type="submit"
                class="btn btn-primary btn-block btn-submit"
                :class="{ 'loading': authLoading }"
                :disabled="authLoading">
                <span x-text="authLoading ? 'Sending...' : 'Send Reset Link'"></span>
              </button>
            </form>
          </div>

          <!-- UPDATE PASSWORD SURFACE -->
          <div class="auth-surface" :class="{ 'active': authSurface === 'updatePassword' }">
            <h2 style="margin-bottom: 0.5rem; font-size: 1.25rem;">Set New Password</h2>
            <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem; font-size: 0.875rem;">
              Enter your new password below.
            </p>

            <!-- Success State -->
            <template x-if="passwordUpdateSuccess">
              <div>
                <div class="success-message">
                  Your password has been updated successfully!
                </div>
                <button
                  type="button"
                  class="btn btn-primary btn-block"
                  @click="goToLoginAfterPasswordUpdate()">
                  Go to Login
                </button>
              </div>
            </template>

            <!-- Form State -->
            <template x-if="!passwordUpdateSuccess">
              <form @submit.prevent="handlePasswordUpdate">
                <!-- Error Message -->
                <div x-show="error && authSurface === 'updatePassword'" class="error-message" x-text="error"></div>

                <div class="form-group">
                  <label for="update-password">New Password</label>
                  <div class="input-wrapper">
                    <input
                      :type="showUpdatePassword ? 'text' : 'password'"
                      id="update-password"
                      class="input has-toggle"
                      x-model="authPassword"
                      placeholder="Enter new password"
                      required
                      minlength="6">
                    <button type="button" class="password-toggle" @click="togglePasswordVisibility('update')">
                      <svg x-show="!showUpdatePassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      <svg x-show="showUpdatePassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                      </svg>
                    </button>
                  </div>
                  <p class="password-hint">Minimum 6 characters</p>
                </div>

                <div class="form-group">
                  <label for="update-confirm">Confirm New Password</label>
                  <div class="input-wrapper">
                    <input
                      :type="showUpdateConfirmPassword ? 'text' : 'password'"
                      id="update-confirm"
                      class="input has-toggle"
                      x-model="authConfirmPassword"
                      placeholder="Confirm new password"
                      required
                      minlength="6">
                    <button type="button" class="password-toggle" @click="togglePasswordVisibility('updateConfirm')">
                      <svg x-show="!showUpdateConfirmPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      <svg x-show="showUpdateConfirmPassword" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                      </svg>
                    </button>
                  </div>
                </div>

                <button
                  type="submit"
                  class="btn btn-primary btn-block btn-submit"
                  :class="{ 'loading': authLoading }"
                  :disabled="authLoading">
                  <span x-text="authLoading ? 'Updating...' : 'Update Password'"></span>
                </button>
              </form>
            </template>
          </div>

        </div>

        <!-- Footer - changes based on active surface -->
        <div class="auth-footer">
          <template x-if="authSurface === 'login'">
            <span>Don't have an account? <a href="#" @click.prevent="switchAuthSurface('register')">Sign up</a></span>
          </template>
          <template x-if="authSurface === 'register'">
            <span>Already have an account? <a href="#" @click.prevent="switchAuthSurface('login')">Login</a></span>
          </template>
          <template x-if="authSurface === 'reset'">
            <span>Remember your password? <a href="#" @click.prevent="switchAuthSurface('login')">Login</a></span>
          </template>
          <template x-if="authSurface === 'updatePassword'">
            <span></span>
          </template>
        </div>
      </div>
    </div>

    <!-- Dashboard Surface -->
    <div x-show="!isLoading && currentSurface === 'dashboard'" class="dashboard-surface">

      <!-- Header -->
      <header class="app-header">
        <div class="header-content">
          <h1 class="app-title">FitTrack</h1>
          <button @click="handleLogout" class="btn btn-secondary">Logout</button>
        </div>
      </header>

      <div class="dashboard-content">

        <!-- Templates Section -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">My Templates</h2>
            <button @click="createNewTemplate" class="btn btn-primary">Create Template</button>
          </div>

          <div class="templates-grid">
            <template x-for="template in templates" :key="template.id">
              <div class="card template-card">
                <div class="template-header">
                  <h3 class="template-name" x-text="template.name"></h3>
                  <span class="badge" x-text="template.exercises.length + ' exercises'"></span>
                </div>
                <div class="template-actions">
                  <button @click="startWorkoutFromTemplate(template)" class="btn btn-primary">
                    Start Workout
                  </button>
                  <button @click="editTemplate(template)" class="btn btn-icon" title="Edit">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                    </svg>
                  </button>
                  <button @click="deleteTemplate(template.id)" class="btn btn-icon btn-danger" title="Delete">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </template>
          </div>

          <div x-show="templates.length === 0" class="empty-state">
            <p>No templates yet. Create your first workout template to get started!</p>
          </div>
        </section>

        <!-- Charts Section -->
        <section class="section">
          <div class="section-header">
            <h2 class="section-title">Progress Charts</h2>
            <button @click="openAddChartModal" class="btn btn-primary">Add Chart</button>
          </div>

          <div class="charts-grid">
            <template x-for="chart in userCharts" :key="chart.id">
              <div class="card chart-card">
                <div class="chart-header">
                  <div class="chart-info">
                    <h3 class="chart-title" x-text="chart.exercises?.name || 'Exercise'"></h3>
                    <div class="chart-meta">
                      <span class="badge" x-text="chart.metric_type"></span>
                      <span class="badge" x-text="chart.x_axis_mode"></span>
                    </div>
                  </div>
                  <button @click="removeChart(chart.id)" class="btn btn-icon btn-danger" title="Remove">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                <div class="chart-canvas-container">
                  <canvas :id="'chart-' + chart.id"></canvas>
                </div>
              </div>
            </template>
          </div>

          <div x-show="userCharts.length === 0" class="empty-state">
            <p>No charts yet. Add a chart to track your progress!</p>
          </div>
        </section>

      </div>
    </div>

    <!-- Template Editor Surface -->
    <div x-show="!isLoading && currentSurface === 'templateEditor'" class="template-editor-surface">

      <header class="app-header">
        <button @click="cancelTemplateEdit" class="btn btn-secondary">Cancel</button>
        <h1 class="app-title" x-text="editingTemplate.id ? 'Edit Template' : 'New Template'"></h1>
        <button @click="saveTemplate" class="btn btn-primary" :disabled="!editingTemplate.name.trim()">
          Save
        </button>
      </header>

      <div class="editor-content">
        <form @submit.prevent="saveTemplate" class="editor-form">

          <div class="form-group">
            <label for="template-name">Template Name</label>
            <input
              id="template-name"
              type="text"
              x-model="editingTemplate.name"
              class="input"
              placeholder="e.g., Upper Body Day"
              required>
          </div>

          <div class="form-section">
            <div class="section-header">
              <h3>Exercises</h3>
              <button type="button" @click="openExercisePickerForTemplate" class="btn btn-primary">
                Add Exercise
              </button>
            </div>

            <div class="exercises-list">
              <template x-for="(ex, exIndex) in editingTemplate.exercises" :key="exIndex">
                <div class="card exercise-editor-card">
                  <!-- Exercise Header -->
                  <div class="exercise-header">
                    <div class="exercise-title-row">
                      <span class="exercise-name" x-text="ex.name"></span>
                      <span class="badge" x-text="ex.category"></span>
                    </div>
                    <div class="exercise-header-actions">
                      <button type="button" @click="moveExerciseUp(exIndex)"
                              class="btn btn-icon" :disabled="exIndex === 0" title="Move up">
                        <span>↑</span>
                      </button>
                      <button type="button" @click="moveExerciseDown(exIndex)"
                              class="btn btn-icon" :disabled="exIndex === editingTemplate.exercises.length - 1" title="Move down">
                        <span>↓</span>
                      </button>
                      <button type="button" @click="removeExerciseFromTemplate(exIndex)"
                              class="btn btn-icon btn-danger" title="Remove">
                        <span>✕</span>
                      </button>
                    </div>
                  </div>

                  <!-- Set Table -->
                  <div class="set-table">
                    <div class="set-header">
                      <span>Set</span>
                      <span>lbs</span>
                      <span>Reps</span>
                      <span></span>
                    </div>

                    <template x-for="(set, setIndex) in ex.sets" :key="setIndex">
                      <div class="set-row">
                        <div class="set-number" x-text="set.set_number"></div>
                        <input type="number" class="set-input" x-model.number="set.weight"
                               min="0" step="0.5" placeholder="0">
                        <input type="number" class="set-input" x-model.number="set.reps"
                               min="0" placeholder="10">
                        <button type="button" class="btn btn-icon btn-danger btn-small"
                                @click="removeSetFromTemplateExercise(exIndex, setIndex)"
                                x-show="ex.sets.length > 1" title="Remove Set">
                          <span>✕</span>
                        </button>
                      </div>
                    </template>
                  </div>

                  <!-- Add Set Button -->
                  <button type="button" class="btn btn-add-set"
                          @click="addSetToTemplateExercise(exIndex)">
                    + Add Set
                  </button>

                  <!-- Rest Time (shared for all sets) -->
                  <div class="rest-time-row">
                    <label>Rest between sets:</label>
                    <input type="number" class="input input-small"
                           x-model.number="ex.default_rest_seconds" min="0" placeholder="60">
                    <span class="input-suffix">seconds</span>
                  </div>
                </div>
              </template>
            </div>

            <div x-show="editingTemplate.exercises.length === 0" class="empty-state">
              <p>No exercises added yet. Click "Add Exercise" to start building your template.</p>
            </div>
          </div>

        </form>
      </div>
    </div>

    <!-- Workout Surface -->
    <div x-show="!isLoading && currentSurface === 'workout'" class="workout-surface" @click="handleSwipeCancel()">

      <header class="app-header workout-header">
        <button @click="cancelWorkout" class="btn btn-secondary btn-sm">Cancel</button>
        <div class="workout-info">
          <h1 class="app-title" x-text="activeWorkout.template_name"></h1>
          <p class="workout-time" x-text="formatWorkoutDate(activeWorkout.started_at)"></p>
        </div>
        <button @click="finishWorkout" class="btn btn-primary btn-sm">Finish</button>
      </header>

      <div class="workout-content">

        <!-- Exercises List -->
        <div class="exercises-list">
          <template x-for="(ex, exIndex) in activeWorkout.exercises" :key="exIndex">
            <div class="card exercise-workout-card">
              <!-- Exercise Header -->
              <div class="exercise-header">
                <div class="exercise-title-row">
                  <span class="exercise-name" x-text="ex.name"></span>
                  <span class="badge" x-text="ex.category"></span>
                </div>
                <button
                  type="button"
                  @click="removeExerciseFromWorkout(exIndex)"
                  class="btn btn-icon btn-danger"
                  title="Remove Exercise">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>

              <!-- Set Table -->
              <div class="set-table">
                <div class="set-header">
                  <span>Set</span>
                  <span>lbs</span>
                  <span>Reps</span>
                  <span></span>
                </div>

                <template x-for="(set, setIndex) in ex.sets" :key="setIndex">
                  <div
                    class="set-row-wrapper"
                    @pointerdown="handleSwipeStart($event)"
                    @pointermove="handleSwipeMove($event)"
                    @pointerup="handleSwipeEnd($event)"
                    @pointercancel="handleSwipeEnd($event)"
                    @touchstart="handleSwipeStart($event)"
                    @touchmove.prevent="handleSwipeMove($event)"
                    @touchend="handleSwipeEnd($event)"
                    @click.stop>
                    <div class="set-row" :class="{ 'set-done': set.is_done }">
                      <div class="set-number" x-text="set.set_number"></div>
                      <input
                        type="number"
                        class="set-input"
                        x-model.number="set.weight"
                        min="0"
                        step="0.5"
                        placeholder="0">
                      <input
                        type="number"
                        class="set-input"
                        x-model.number="set.reps"
                        min="0"
                        placeholder="0">
                      <div class="set-checkbox">
                        <button
                          type="button"
                          class="checkbox-btn"
                          :class="{ 'checked': set.is_done }"
                          @click="set.is_done = !set.is_done; if(set.is_done) startRestTimer(ex.rest_seconds, exIndex)">
                          <span x-show="set.is_done">&#10003;</span>
                        </button>
                      </div>
                    </div>
                    <button
                      type="button"
                      class="btn-remove-set"
                      @click="deleteSetWithSwipeReset(exIndex, setIndex)"
                      x-show="ex.sets.length > 1"
                      title="Remove Set">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                      </svg>
                    </button>
                  </div>
                </template>
              </div>

              <!-- Rest Timer Bar -->
              <div class="rest-timer-bar-container">
                <div class="rest-timer-bar-wrapper">
                  <div class="rest-timer-bar-fill"
                       :class="{
                         'idle': !isTimerActiveForExercise(exIndex),
                         'running': isTimerActiveForExercise(exIndex) && timerSeconds > 0,
                         'complete': isTimerActiveForExercise(exIndex) && timerSeconds === 0
                       }"
                       :style="'width: ' + getTimerProgress(exIndex) + '%'">
                  </div>
                  <span class="rest-timer-bar-time" x-text="formatTime(isTimerActiveForExercise(exIndex) ? timerSeconds : ex.rest_seconds)"></span>
                </div>
                <div class="rest-timer-controls">
                  <button class="btn-timer-adjust" @click="adjustTimer(-10, exIndex)">-10s</button>
                  <button class="btn-timer-adjust" @click="adjustTimer(10, exIndex)">+10s</button>
                </div>
              </div>

              <!-- Add Set Button -->
              <button
                type="button"
                class="btn btn-add-set"
                @click="addSetToExercise(exIndex)">
                + Add Set
              </button>
            </div>
          </template>
        </div>

        <div x-show="activeWorkout.exercises.length === 0" class="empty-state">
          <p>No exercises in this workout. Add some below!</p>
        </div>

        <!-- Add Exercise Button -->
        <div class="workout-footer">
          <button @click="openExercisePickerForWorkout" class="btn btn-primary btn-block">
            Add Exercise
          </button>
        </div>

      </div>
    </div>

    <!-- Exercise Picker Modal -->
    <div x-show="showExercisePicker" class="modal-overlay" @click.self="closeExercisePicker">
      <div class="modal">
        <div class="modal-header">
          <h2>Add Exercise</h2>
          <button @click="closeExercisePicker" class="btn btn-icon" title="Close">
            <span>✕</span>
          </button>
        </div>

        <div class="modal-body">

          <div class="form-group">
            <input
              type="text"
              x-model="exerciseSearchQuery"
              class="input"
              placeholder="Search exercises...">
          </div>

          <button
            type="button"
            @click="showNewExerciseForm = !showNewExerciseForm"
            class="btn btn-secondary btn-block">
            <span x-text="showNewExerciseForm ? 'Cancel New Exercise' : 'Create New Exercise'"></span>
          </button>

          <!-- New Exercise Form -->
          <div x-show="showNewExerciseForm" class="new-exercise-form">
            <form @submit.prevent="createNewExercise">
              <div class="form-group">
                <label for="new-exercise-name">Exercise Name</label>
                <input
                  id="new-exercise-name"
                  type="text"
                  x-model="newExerciseName"
                  class="input"
                  placeholder="e.g., Barbell Squat"
                  required>
              </div>

              <div class="form-group">
                <label for="new-exercise-category">Category</label>
                <select
                  id="new-exercise-category"
                  x-model="newExerciseCategory"
                  class="input"
                  required>
                  <option value="">Select category...</option>
                  <option value="Legs">Legs</option>
                  <option value="Chest">Chest</option>
                  <option value="Back">Back</option>
                  <option value="Shoulders">Shoulders</option>
                  <option value="Arms">Arms</option>
                  <option value="Core">Core</option>
                  <option value="Cardio">Cardio</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="form-actions">
                <button type="button" @click="showNewExerciseForm = false" class="btn btn-secondary">
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">Create</button>
              </div>
            </form>
          </div>

          <!-- Exercise List -->
          <div class="exercise-list">
            <template x-for="exercise in filteredExercises" :key="exercise.id">
              <div
                @click="selectExercise(exercise)"
                class="exercise-list-item">
                <div class="exercise-item-info">
                  <span class="exercise-item-name" x-text="exercise.name"></span>
                  <span class="badge badge-small" x-text="exercise.category"></span>
                </div>
              </div>
            </template>
          </div>

          <div x-show="filteredExercises.length === 0 && !showNewExerciseForm" class="empty-state">
            <p>No exercises found. Try a different search or create a new exercise.</p>
          </div>

        </div>
      </div>
    </div>

    <!-- Add Chart Modal -->
    <div x-show="showAddChartModal" class="modal-overlay" @click.self="closeAddChartModal">
      <div class="modal">
        <div class="modal-header">
          <h2>Add Progress Chart</h2>
          <button @click="closeAddChartModal" class="btn btn-icon" title="Close">
            <span>✕</span>
          </button>
        </div>

        <div class="modal-body">
          <form @submit.prevent="createChart">

            <div class="form-group">
              <label for="chart-exercise">Exercise</label>
              <select
                id="chart-exercise"
                x-model="newChart.exercise_id"
                class="input"
                required>
                <option value="">Select exercise...</option>
                <template x-for="exercise in availableExercises" :key="exercise.id">
                  <option :value="exercise.id" x-text="exercise.name"></option>
                </template>
              </select>
            </div>

            <div class="form-group">
              <label for="chart-metric">Metric Type</label>
              <select
                id="chart-metric"
                x-model="newChart.metric_type"
                class="input"
                required>
                <option value="">Select metric...</option>
                <option value="total_sets">Total Sets</option>
                <option value="max_volume_set">Max Volume Set</option>
              </select>
            </div>

            <div class="form-group">
              <label for="chart-xaxis">X-Axis Mode</label>
              <select
                id="chart-xaxis"
                x-model="newChart.x_axis_mode"
                class="input"
                required>
                <option value="">Select mode...</option>
                <option value="date">By Date</option>
                <option value="session">By Session</option>
              </select>
            </div>

            <div class="form-actions">
              <button type="button" @click="closeAddChartModal" class="btn btn-secondary">
                Cancel
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                :disabled="!newChart.exercise_id || !newChart.metric_type || !newChart.x_axis_mode">
                Add Chart
              </button>
            </div>

          </form>
        </div>
      </div>
    </div>

    <!-- Template Update Modal -->
    <div x-show="showTemplateUpdateModal" class="modal-overlay" @click.self="declineTemplateUpdate">
      <div class="modal modal-sm">
        <div class="modal-header">
          <h2>Update Template?</h2>
        </div>
        <div class="modal-body">
          <p>You made changes during this workout. Update the template with these changes?</p>
          <p class="text-muted">This will update exercises, sets, weights, and reps.</p>
        </div>
        <div class="modal-footer">
          <button @click="declineTemplateUpdate" class="btn btn-secondary">No, Keep Original</button>
          <button @click="confirmTemplateUpdate" class="btn btn-primary">Yes, Update</button>
        </div>
      </div>
    </div>

    <!-- Finish Workout Modal -->
    <div x-show="showFinishWorkoutModal" class="modal-overlay" @click.self="dismissFinishWorkoutModal">
      <div class="modal modal-sm">
        <div class="modal-header">
          <h2>Finish Workout?</h2>
        </div>
        <div class="modal-body">
          <p>Save this workout and end your session?</p>
        </div>
        <div class="modal-footer">
          <button @click="dismissFinishWorkoutModal" class="btn btn-secondary">Cancel</button>
          <button @click="confirmFinishWorkout" class="btn btn-primary">Save</button>
        </div>
      </div>
    </div>

    <!-- Cancel Workout Modal -->
    <div x-show="showCancelWorkoutModal" class="modal-overlay" @click.self="dismissCancelWorkoutModal">
      <div class="modal modal-sm">
        <div class="modal-header">
          <h2>Cancel Workout?</h2>
        </div>
        <div class="modal-body">
          <p>All progress will be lost. This cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button @click="dismissCancelWorkoutModal" class="btn btn-secondary">Go Back</button>
          <button @click="confirmCancelWorkout" class="btn btn-danger">Discard</button>
        </div>
      </div>
    </div>

    <!-- Delete Chart Modal -->
    <div x-show="showDeleteChartModal" class="modal-overlay" @click.self="dismissDeleteChartModal">
      <div class="modal modal-sm">
        <div class="modal-header">
          <h2>Remove Chart?</h2>
        </div>
        <div class="modal-body">
          <p>Remove this chart from your dashboard?</p>
          <p class="text-muted">This cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button @click="dismissDeleteChartModal" class="btn btn-secondary">Keep Chart</button>
          <button @click="confirmDeleteChart" class="btn btn-danger">Remove</button>
        </div>
      </div>
    </div>

    <!-- Toast Messages -->
    <div class="toast-container">
      <div x-show="error" class="toast toast-error">
        <span x-text="error"></span>
        <button @click="error = ''" class="btn btn-icon btn-small">
          <span>✕</span>
        </button>
      </div>

      <div x-show="successMessage" class="toast toast-success">
        <span x-text="successMessage"></span>
        <button @click="successMessage = ''" class="btn btn-icon btn-small">
          <span>✕</span>
        </button>
      </div>
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Local config (gitignored) - create this file with your Supabase credentials -->
  <script src="js/config.local.js"></script>
  <script src="js/supabase.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/exercises.js"></script>
  <script src="js/templates.js"></script>
  <script src="js/logging.js"></script>
  <script src="js/timer.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
