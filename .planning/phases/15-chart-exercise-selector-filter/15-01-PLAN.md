---
phase: 15-chart-exercise-selector-filter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/services/exercises.ts
  - packages/shared/src/types/services.ts
  - apps/web/src/surfaces/dashboard/DashboardSurface.tsx
  - apps/web/src/surfaces/dashboard/AddChartModal.tsx
autonomous: true

must_haves:
  truths:
    - "User opens Add Chart modal and sees only exercises they have logged"
    - "Exercises without any session data do not appear in the dropdown"
    - "User with no logged sessions sees 'No exercise data yet' message"
    - "Exercise list is grouped by category with optgroup headers"
  artifacts:
    - path: "packages/shared/src/services/exercises.ts"
      provides: "getExercisesWithLoggedData function"
      contains: "getExercisesWithLoggedData"
    - path: "apps/web/src/surfaces/dashboard/DashboardSurface.tsx"
      provides: "Filtered exercise loading on modal open"
      contains: "exercisesWithData"
    - path: "apps/web/src/surfaces/dashboard/AddChartModal.tsx"
      provides: "Empty state and grouped exercise display"
      contains: "No exercise data yet"
  key_links:
    - from: "DashboardSurface.tsx"
      to: "exercises.getExercisesWithLoggedData"
      via: "async call in openAddChartModal"
      pattern: "getExercisesWithLoggedData"
    - from: "DashboardSurface.tsx"
      to: "AddChartModal"
      via: "exercises prop"
      pattern: "exercises=\\{exercisesWithData\\}"
---

<objective>
Filter the exercise dropdown in Add Chart modal to only show exercises with logged workout data.

Purpose: Users should only create charts for exercises they have actually tracked, preventing empty charts and improving UX.
Output: Service function, integrated modal with filtered list and empty state handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-chart-exercise-selector-filter/15-CONTEXT.md
@.planning/phases/15-chart-exercise-selector-filter/15-RESEARCH.md

Key decisions from CONTEXT.md:
- Empty state text: "No exercise data yet" (minimal, no call-to-action)
- Exercise list: Alphabetical within categories, grouped by category headers
- Data refresh: Query on modal open (not cached)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getExercisesWithLoggedData service function</name>
  <files>
    packages/shared/src/services/exercises.ts
    packages/shared/src/types/services.ts
  </files>
  <action>
Add a new function `getExercisesWithLoggedData()` to the exercises service that queries exercises with at least one workout_log_exercises record for the current user.

Implementation pattern (from RESEARCH.md):
1. Get current user via `supabase.auth.getUser()`
2. Query `workout_log_exercises` with inner join to `exercises` and `workout_logs`
3. Filter by `workout_logs.user_id` = current user
4. Deduplicate exercises using Map
5. Sort by category then name (A-Z)
6. Return ServiceResult<Exercise[]>

Query structure:
```typescript
await supabase
  .from('workout_log_exercises')
  .select(`
    exercise_id,
    exercises!inner (id, name, category, is_system, user_id, equipment, instructions, level, force, mechanic),
    workout_logs!inner (user_id)
  `)
  .eq('workout_logs.user_id', user.id)
```

Update ExercisesService interface in types/services.ts to include:
```typescript
getExercisesWithLoggedData(): Promise<ServiceResult<Exercise[]>>;
```

Add to the exercises export object at the end of exercises.ts.
  </action>
  <verify>
TypeScript compiles: `cd packages/shared && npx tsc --noEmit`
  </verify>
  <done>
Function exported from exercises service, accepts no args, returns Promise<ServiceResult<Exercise[]>>
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate filtered exercises in DashboardSurface</name>
  <files>apps/web/src/surfaces/dashboard/DashboardSurface.tsx</files>
  <action>
Modify DashboardSurface to load filtered exercises when Add Chart modal opens.

Changes:
1. Add new state: `const [exercisesWithData, setExercisesWithData] = useState<Exercise[]>([]);`

2. Make `openAddChartModal` async and call the new service:
```typescript
const openAddChartModal = async (): Promise<void> => {
  setShowAddChartModal(true);
  setChartError('');
  clearMessages();

  // Refresh exercises with logged data
  const { data, error } = await exercises.getExercisesWithLoggedData();
  if (!error && data) {
    setExercisesWithData(data);
  }
};
```

3. Update AddChartModal prop from `exercises={availableExercises}` to `exercises={exercisesWithData}`

Note: Keep `availableExercises` state for other uses (template editor). Only use `exercisesWithData` for the chart modal.
  </action>
  <verify>
App compiles: `cd apps/web && npm run build`
  </verify>
  <done>
Modal opens, calls getExercisesWithLoggedData, passes filtered list to AddChartModal
  </done>
</task>

<task type="auto">
  <name>Task 3: Update AddChartModal with empty state and grouped display</name>
  <files>apps/web/src/surfaces/dashboard/AddChartModal.tsx</files>
  <action>
Modify AddChartModal to handle empty exercises array and display grouped exercise list.

Changes:

1. Add useMemo import if not present

2. Create grouped exercises memo:
```typescript
const groupedExercises = useMemo(() => {
  const groups: Record<string, Exercise[]> = {};
  exercises.forEach(ex => {
    if (!groups[ex.category]) {
      groups[ex.category] = [];
    }
    groups[ex.category].push(ex);
  });
  // Sort exercises within each category
  Object.values(groups).forEach(group => {
    group.sort((a, b) => a.name.localeCompare(b.name));
  });
  // Return sorted category entries
  return Object.entries(groups).sort(([a], [b]) => a.localeCompare(b));
}, [exercises]);
```

3. Replace the current exercise select with conditional rendering:
```tsx
{exercises.length === 0 ? (
  <div class="empty-state">
    <p>No exercise data yet</p>
  </div>
) : (
  <div class="form-group">
    <label for="chart-exercise">Exercise</label>
    <select
      id="chart-exercise"
      class="input"
      value={selectedExerciseId}
      onChange={handleExerciseChange}
      required
    >
      <option value="">Select an exercise...</option>
      {groupedExercises.map(([category, categoryExercises]) => (
        <optgroup key={category} label={category}>
          {categoryExercises.map((exercise) => (
            <option key={exercise.id} value={exercise.id}>
              {exercise.name}
            </option>
          ))}
        </optgroup>
      ))}
    </select>
  </div>
)}
```

4. Remove the sortedExercises variable (replaced by groupedExercises)

5. When empty state shown, also hide the form submit button or disable form submission (no exercise to select)
  </action>
  <verify>
App compiles: `cd apps/web && npm run build`
  </verify>
  <done>
Empty exercises shows "No exercise data yet" message. Non-empty shows grouped optgroup dropdown.
  </done>
</task>

</tasks>

<verification>
1. Build passes: `npm run build` from project root
2. No TypeScript errors in modified files
3. Manual test: Open Add Chart modal, verify dropdown shows only exercises with logged data
4. Manual test: If no exercises have logged data, "No exercise data yet" message appears
</verification>

<success_criteria>
- CHART-01: Exercise dropdown only shows exercises with logged session data
- CHART-02: When no exercises have data, show message instead of dropdown
- Exercise list grouped by category with optgroup elements
- Data refreshes each time modal opens
</success_criteria>

<output>
After completion, create `.planning/phases/15-chart-exercise-selector-filter/15-01-SUMMARY.md`
</output>
