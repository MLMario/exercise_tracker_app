---
phase: 12-bug-fixes
plan: 01
type: execute
depends_on: []
files_modified: [src/main.tsx, src/surfaces/auth/AuthSurface.tsx]
---

<objective>
Fix navigation bugs discovered in v1.0 UAT: workout visibility on alt-tab and password recovery routing.

Purpose: Restore correct navigation behavior for critical user flows.
Output: Users can alt-tab during workouts without losing the workout surface, and password recovery redirects correctly to login after success.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-bug-fixes/CONTEXT.md
@src/main.tsx
@src/surfaces/auth/AuthSurface.tsx

**Bug Analysis:**

1. **Workout Visibility (main.tsx:139-144)**: SIGNED_IN event handler redirects to dashboard unconditionally when `!isPasswordRecoveryMode`. When browser regains focus after alt-tab, Supabase may fire SIGNED_IN for token refresh, causing workout to disappear.

2. **Password Recovery Routing (main.tsx + AuthSurface.tsx)**: App's `isPasswordRecoveryMode` state in main.tsx is set to true on recovery detection but never cleared after successful password update. The auth listener's closure captures this value, so subsequent SIGNED_IN events don't navigate to dashboard.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix workout visibility on alt-tab</name>
  <files>src/main.tsx</files>
  <action>
In the SIGNED_IN event handler (lines 139-144), add a check to skip navigation if user is already on a functional surface (workout or templateEditor). These surfaces should not be interrupted by auth state refresh events.

Change from:
```typescript
} else if (event === 'SIGNED_IN') {
  if (!isPasswordRecoveryMode && session?.user) {
    setUser(session.user);
    setCurrentSurface('dashboard');
  }
}
```

To:
```typescript
} else if (event === 'SIGNED_IN') {
  if (!isPasswordRecoveryMode && session?.user) {
    setUser(session.user);
    // Only navigate to dashboard if coming from auth surface
    // Don't interrupt workout or template editor surfaces
    if (currentSurface === 'auth') {
      setCurrentSurface('dashboard');
    }
  }
}
```

NOTE: The callback closure captures `currentSurface` from effect creation time. To fix this, either:
1. Use a ref to track currentSurface, or
2. Add currentSurface to useEffect dependency array and handle subscription cleanup/recreation

Use option 1 (useRef) since it's simpler and doesn't cause subscription churn:
- Add `const currentSurfaceRef = useRef(currentSurface);`
- Update ref in useEffect: `currentSurfaceRef.current = currentSurface;`
- Use ref in handler: `if (currentSurfaceRef.current === 'auth')`
  </action>
  <verify>Build succeeds: `npm run build` passes without errors</verify>
  <done>SIGNED_IN handler only navigates to dashboard when currentSurface is 'auth', workout and templateEditor surfaces are preserved</done>
</task>

<task type="auto">
  <name>Task 2: Fix password recovery routing after success</name>
  <files>src/surfaces/auth/AuthSurface.tsx, src/main.tsx</files>
  <action>
Two fixes required:

**Fix A - Clear URL hash after password update (AuthSurface.tsx):**
In `goToLoginAfterPasswordUpdate` function (around line 286), clear the URL hash to remove recovery tokens:
```typescript
const goToLoginAfterPasswordUpdate = () => {
  setPasswordUpdateSuccess(false);
  setIsPasswordRecoveryMode(false);
  // Clear URL hash to remove recovery tokens - prevents main.tsx from re-detecting recovery mode
  if (window.location.hash) {
    history.replaceState(null, '', window.location.pathname);
  }
  setAuthSurface('login');
  setError('');
  setSuccessMessage('');
  setShowUpdatePassword(false);
  setShowUpdateConfirmPassword(false);
};
```

**Fix B - Use ref for isPasswordRecoveryMode (main.tsx):**
Same pattern as Task 1 - the closure captures the initial value. Add a ref and keep it in sync:
- Add `const isPasswordRecoveryModeRef = useRef(isPasswordRecoveryMode);`
- Sync ref when state changes: `isPasswordRecoveryModeRef.current = isPasswordRecoveryMode;`
- Use ref in handler: `if (!isPasswordRecoveryModeRef.current && session?.user)`

This ensures the SIGNED_IN handler always has the current value.
  </action>
  <verify>Build succeeds: `npm run build` passes without TypeScript errors</verify>
  <done>After password update and clicking "Go to Login", user can log in and will be redirected to dashboard correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes
- [ ] No new TypeScript warnings introduced
</verification>

<success_criteria>

- All tasks completed
- Both useRef patterns implemented correctly for closure fixes
- URL hash cleared after password update success
- SIGNED_IN only navigates to dashboard from auth surface
</success_criteria>

<output>
After completion, create `.planning/phases/12-bug-fixes/12-01-SUMMARY.md`:

# Plan 12-01 Summary: Navigation Bug Fixes

**Fixed workout visibility on alt-tab and password recovery routing**

## Accomplishments

- [Key outcomes]

## Files Modified

- `src/main.tsx` - Added refs for closure-safe state access
- `src/surfaces/auth/AuthSurface.tsx` - Clear URL hash after password update

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 12-02-PLAN.md (chart fix and console cleanup)
</output>
