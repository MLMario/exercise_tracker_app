---
phase: 06-setrow-swipe-refactor
plan: 01
type: execute
wave: 1
depends_on: [05-01]
files_modified: [apps/web/src/surfaces/workout/SetRow.tsx]
autonomous: true
---

<objective>
Replace manual pointer event handlers in SetRow.tsx with useDrag hook from @use-gesture/react.

Purpose: Simplify ~115 lines of manual gesture handling to ~30 lines using useDrag
Output: SetRow with cleaner swipe implementation preserving all existing behavior
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-use-gesture-setup/05-RESEARCH.md
@apps/web/src/surfaces/workout/SetRow.tsx

**Key behavioral requirements to preserve:**
- Left swipe only (movement constrained to negative X)
- Max drag distance: -80px
- Snap threshold: -40px (if past, snap to revealed)
- Revealed position: translateX(-70px)
- Tap on revealed row closes it
- Delete button clicks must pass through
- Parent reset via shouldResetSwipe prop
- Callback onSwipeStateChange when state changes
- `.swiping` CSS class during active drag (used by CSS for transition disable and button visibility)

**useDrag provides:**
- `axis: 'x'` - horizontal constraint
- `filterTaps: true` - distinguishes taps from drags
- `movement[0]` - total X displacement
- `active` - currently dragging
- `tap` - was this a tap (when filterTaps enabled)

**CSS dependencies on `.swiping` class (apps/web/css/styles.css):**
- Line 1691: `.set-row-wrapper.swiping .set-row { transition: none; }` - disables transition during drag
- Line 1734: `.set-row-wrapper.swiping .btn-remove-set { opacity: 1; ... }` - shows button during drag
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace SwipeData state with useDrag</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx</files>
  <action>
1. REMOVE the SwipeData interface (lines 23-29)
2. REMOVE the swipeData state: `const [swipeData, setSwipeData] = useState<SwipeData | null>(null)`
3. ADD isDragging state to preserve CSS class functionality:
   ```typescript
   const [isDragging, setIsDragging] = useState(false);
   ```
4. KEEP these existing items:
   - `isRevealed` state (needed for tracking revealed state)
   - `wrapperRef` (needed for wrapper div)
   - `setRowRef` (needed for transform application)
   - `resetSwipe` callback (refactor to simpler version)

5. ADD useDrag hook implementation:
```typescript
const bind = useDrag(
  ({ movement: [mx], active, tap, event }) => {
    // Don't interfere with delete button clicks
    if ((event?.target as HTMLElement)?.closest('.btn-remove-set')) {
      return;
    }

    // Tap on revealed row closes it
    if (tap && isRevealed) {
      resetSwipe();
      return;
    }

    // Track dragging state for CSS class
    setIsDragging(active);

    // Constrain to left swipe only, max -80px
    const x = Math.max(-80, Math.min(0, mx));

    if (active) {
      // During drag - follow finger
      if (setRowRef.current) {
        setRowRef.current.style.transform = `translateX(${x}px)`;
      }
    } else if (!tap) {
      // On release (not tap) - snap to position
      const threshold = -40;
      if (mx < threshold) {
        // Snap to revealed
        setIsRevealed(true);
        if (setRowRef.current) {
          setRowRef.current.style.transform = 'translateX(-70px)';
        }
        onSwipeStateChange?.(true);
      } else {
        // Snap back
        resetSwipe();
      }
    }
  },
  {
    axis: 'x',
    filterTaps: true,
  }
);
```

6. UPDATE resetSwipe to simpler version (remove swipeData references):
```typescript
const resetSwipe = useCallback((): void => {
  setIsRevealed(false);
  setIsDragging(false);
  if (setRowRef.current) {
    setRowRef.current.style.transform = '';
  }
  onSwipeStateChange?.(false);
}, [onSwipeStateChange]);
```
  </action>
  <verify>TypeScript compiles: cd apps/web && pnpm exec tsc --noEmit</verify>
  <done>SwipeData removed, useDrag hook added, isDragging state preserves CSS class behavior</done>
</task>

<task type="auto">
  <name>Task 2: Remove manual event handlers</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx</files>
  <action>
1. REMOVE these functions entirely:
   - handleSwipeStart (lines 108-135)
   - handleSwipeMove (lines 141-172)
   - handleSwipeEnd (lines 179-207)

2. These were ~100 lines of manual pointer event handling that useDrag now handles internally.
  </action>
  <verify>TypeScript compiles: cd apps/web && pnpm exec tsc --noEmit</verify>
  <done>Manual handlers removed, no unused function warnings</done>
</task>

<task type="auto">
  <name>Task 3: Update JSX event bindings</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx</files>
  <action>
1. REMOVE all pointer/touch event handlers from wrapper div:
   - onPointerDown={handleSwipeStart}
   - onPointerMove={handleSwipeMove}
   - onPointerUp={handleSwipeEnd}
   - onPointerCancel={handleSwipeEnd}
   - onTouchStart={handleSwipeStart}
   - onTouchMove={handleSwipeMove}
   - onTouchEnd={handleSwipeEnd}

2. REMOVE the wrapperStyle conditional logic entirely (lines 259-261)

3. UPDATE wrapper div to use bind() and static touchAction:
```jsx
<div
  ref={wrapperRef}
  class={`set-row-wrapper ${isDragging ? 'swiping' : ''} ${isRevealed ? 'swipe-revealed' : ''}`}
  style={{ touchAction: 'pan-y' }}
  {...bind()}
  onClick={(e) => e.stopPropagation()}
>
```

4. UPDATE delete button visibility - use isDragging instead of swipeData?.isDragging:
```jsx
<button
  type="button"
  class="btn-remove-set"
  onClick={handleDelete}
  style={{ visibility: canDelete && (isRevealed || isDragging) ? 'visible' : 'hidden' }}
  title="Remove Set"
>
```

Note: The visibility style is kept as backup, but CSS handles opacity via .swiping and .swipe-revealed classes.
  </action>
  <verify>TypeScript compiles: cd apps/web && pnpm exec tsc --noEmit</verify>
  <done>JSX updated with bind() spread, pointer events removed, isDragging class preserved</done>
</task>

<task type="auto">
  <name>Task 4: Verify complete implementation</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx</files>
  <action>
1. Run full TypeScript check: cd apps/web && pnpm exec tsc --noEmit
2. Run build: cd apps/web && pnpm build
3. Verify useDrag import is being used (not just imported)
4. Verify no remaining references to:
   - SwipeData
   - swipeData
   - handleSwipeStart
   - handleSwipeMove
   - handleSwipeEnd
   - pointerId
   - pointer capture methods
5. Verify isDragging state is used for:
   - CSS class `.swiping` on wrapper
   - Delete button visibility condition
  </action>
  <verify>pnpm --filter @ironlift/web build succeeds</verify>
  <done>Build passes, no type errors, implementation complete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/web && pnpm exec tsc --noEmit` passes
- [ ] `pnpm --filter @ironlift/web build` succeeds
- [ ] SwipeData interface is removed
- [ ] Manual handlers (handleSwipeStart/Move/End) are removed
- [ ] useDrag hook is implemented with axis: 'x' and filterTaps: true
- [ ] isDragging state tracks active drag for CSS class
- [ ] `.swiping` class applied during drag (preserves CSS styling)
- [ ] Delete button visible during drag (not just when revealed)
- [ ] Swipe left reveals delete button at -70px
- [ ] Tap on revealed row closes it
- [ ] shouldResetSwipe prop still works (via existing useEffect)
- [ ] onSwipeStateChange callback fires on reveal/close
</verification>

<must_haves>
Goal-backward verification - Phase 6 goal: "Replace manual pointer handlers in SetRow with useDrag hook"

- [ ] useDrag hook from @use-gesture/react is used
- [ ] Manual pointer event handlers are removed
- [ ] All existing swipe behavior preserved (left swipe, -70px reveal, -40px threshold)
- [ ] CSS class behavior preserved (.swiping during drag, .swipe-revealed when snapped)
- [ ] Build passes without errors
</must_haves>

<success_criteria>
- All tasks completed
- All verification checks pass
- SetRow.tsx reduced from ~320 lines to ~230 lines (approx 90 line reduction)
- Swipe behavior identical to before refactor
- CSS styling preserved (swiping class, swipe-revealed class)
- Phase 6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-setrow-swipe-refactor/06-01-SUMMARY.md`
</output>
