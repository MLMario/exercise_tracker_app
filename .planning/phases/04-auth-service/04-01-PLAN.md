---
phase: 04-auth-service
plan: 01
type: execute
depends_on: []
files_modified: [src/lib/supabase.ts, src/services/auth.ts, src/services/index.ts]
---

<objective>
Migrate auth service to TypeScript with full type safety.

Purpose: Create typed auth service module as foundation for all authenticated operations.
Output: Working `src/services/auth.ts` implementing AuthService interface, Supabase client module.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/02-type-system/02-02-SUMMARY.md

# Types to implement:
@src/types/services.ts

# Existing JS to migrate:
@js/auth.js
@js/supabase.js

**Tech stack available:** Vite, TypeScript, @supabase/supabase-js
**Established patterns:** ServiceResult<T>, AuthResult, SuccessResult, barrel exports

**Constraining decisions:**
- Phase 2: AuthService interface defined - implement exactly as specified
- Phase 2: Use Supabase types (User, Session, AuthChangeEvent, Subscription) directly
- String UUIDs and ISO timestamps from Supabase
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase client module</name>
  <files>src/lib/supabase.ts</files>
  <action>
Create `src/lib/supabase.ts` that:
1. Imports `createClient` from `@supabase/supabase-js`
2. Reads SUPABASE_URL and SUPABASE_ANON_KEY from Vite env vars (`import.meta.env.VITE_SUPABASE_URL`)
3. Creates and exports typed Supabase client
4. Exports to `window.supabaseClient` for backward compatibility with existing JS code

Use Vite's env variable pattern (VITE_ prefix required for client exposure).
Throw clear error if env vars are missing.
  </action>
  <verify>
`npx tsc --noEmit` passes
Import resolves: `import { supabase } from '@/lib/supabase'`
  </verify>
  <done>
- src/lib/supabase.ts exists and exports typed client
- Backward compatibility: window.supabaseClient still works
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth service module</name>
  <files>src/services/auth.ts, src/services/index.ts</files>
  <action>
Create `src/services/auth.ts` implementing the AuthService interface:

1. Import types from `@/types`:
   - AuthService, AuthResult, SuccessResult, ServiceError
   - AuthStateChangeCallback, AuthSubscription

2. Import supabase client from `@/lib/supabase`

3. Implement all 8 methods exactly matching js/auth.js behavior:
   - register(email, password): Validate inputs, call auth.signUp, return AuthResult
   - login(email, password): Validate inputs, call auth.signInWithPassword, return AuthResult
   - logout(): Call auth.signOut, return ServiceError
   - resetPassword(email): Validate input, call auth.resetPasswordForEmail with window.location.origin redirect, return SuccessResult
   - updateUser(password): Validate min 6 chars, call auth.updateUser, return SuccessResult
   - getCurrentUser(): Call auth.getUser, return User or null
   - getSession(): Call auth.getSession, return Session or null
   - onAuthStateChange(callback): Set up listener, return Subscription or null

4. Export auth object implementing AuthService interface

5. Export to window.auth for backward compatibility

Create `src/services/index.ts` barrel export:
- Export everything from './auth'

Important: Preserve exact error handling behavior from js/auth.js:
- Return { user: null, error } on auth failures
- Return { success: false, error } on password operations
- Console.error on caught exceptions
- Validate inputs before calling Supabase
  </action>
  <verify>
`npx tsc --noEmit` passes
All 8 AuthService methods are implemented
  </verify>
  <done>
- src/services/auth.ts implements AuthService interface
- src/services/index.ts exports auth service
- All methods match js/auth.js behavior
- window.auth backward compatibility maintained
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npx tsc --noEmit` passes without errors
- [ ] `npm run build` succeeds
- [ ] src/lib/supabase.ts exports typed client
- [ ] src/services/auth.ts implements all 8 AuthService methods
- [ ] window.supabaseClient and window.auth still work (backward compatibility)
</verification>

<success_criteria>

- Both tasks completed
- All verification checks pass
- No TypeScript errors
- Auth service ready for Phase 6 (Auth Surface) to consume
</success_criteria>

<output>
After completion, create `.planning/phases/04-auth-service/04-01-SUMMARY.md`:

# Phase 4: Auth Service - Plan 01 Summary

**[One-liner: what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/lib/supabase.ts` - Description
- `src/services/auth.ts` - Description
- `src/services/index.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 4 complete, ready for Phase 5: Data Services
</output>
