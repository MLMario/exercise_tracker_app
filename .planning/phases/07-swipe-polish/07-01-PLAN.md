---
phase: 07-swipe-polish
plan: 01
type: execute
wave: 1
depends_on: [06-01]
files_modified: [apps/web/css/styles.css, apps/web/src/surfaces/workout/SetRow.tsx]
autonomous: true
---

<objective>
Add spring animations and gesture refinements to the SetRow swipe-to-delete gesture.

Purpose: Improve swipe feel with physics-based spring animation and add haptic feedback cues
Output: SetRow with smoother, more natural spring animation and refined gesture thresholds
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./06-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-setrow-swipe-refactor/06-01-SUMMARY.md
@apps/web/src/surfaces/workout/SetRow.tsx
@apps/web/css/styles.css

**Current implementation:**
- useDrag hook from @use-gesture/react handles swipe
- CSS transition: `transform 0.2s ease-out` for snap animations
- Threshold at -40px, revealed position at -70px
- No spring physics, basic linear easing

**Spring animation options:**
1. CSS spring-like cubic-bezier curves (no dependencies)
2. @react-spring/web for true physics-based springs (additional dependency)

**Recommendation:** Use CSS approach first (simpler, no deps), evaluate if spring library needed.

**Gesture refinements to consider:**
- Velocity-based snap decision (fast swipe snaps even if below threshold)
- Rubberband effect when over-dragging
- Improved snap animation timing

**Phase 6 deferred issue (06-UAT.md lines 51-54):**
- Delete button stays visible when swiping right to close
- Should hide immediately when closing motion begins
- Root cause: `isDragging` stays true during entire gesture
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spring-like CSS transitions</name>
  <files>apps/web/css/styles.css</files>
  <action>
1. UPDATE the `.set-row-wrapper .set-row` transition to use a spring-like cubic-bezier:

   Replace:
   ```css
   transition: transform 0.2s ease-out;
   ```

   With:
   ```css
   transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
   ```

   This cubic-bezier creates a spring overshoot effect:
   - Fast initial movement
   - Slight overshoot at destination
   - Settles back smoothly

2. UPDATE the `.btn-remove-set` opacity transition to match:

   Replace:
   ```css
   transition: opacity 0.2s ease-out;
   ```

   With:
   ```css
   transition: opacity 0.25s ease-out;
   ```

Location in CSS file: Around lines 1687 and 1716
  </action>
  <verify>CSS syntax is valid: pnpm --filter @ironlift/web build</verify>
  <done>Spring-like CSS transition applied to set-row transform</done>
</task>

<task type="auto">
  <name>Task 2: Add velocity-based snap decision</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx</files>
  <action>
1. UPDATE the useDrag callback to include velocity in snap decision:

   Change the useDrag destructuring from:
   ```typescript
   ({ movement: [mx], active, tap, event })
   ```

   To:
   ```typescript
   ({ movement: [mx], velocity: [vx], active, tap, event })
   ```

2. UPDATE the snap decision logic (around line 119-132) to use velocity:

   Replace:
   ```typescript
   } else if (!tap) {
     // On release (not tap) - snap to position
     const threshold = -40;
     if (mx < threshold) {
       // Snap to revealed
       setIsRevealed(true);
       if (setRowRef.current) {
         setRowRef.current.style.transform = 'translateX(-70px)';
       }
       onSwipeStateChange?.(true);
     } else {
       // Snap back
       resetSwipe();
     }
   }
   ```

   With:
   ```typescript
   } else if (!tap) {
     // On release (not tap) - snap to position
     // Use velocity for quick swipes (vx is in px/ms, typically 0.1-2.0 for normal swipes)
     const positionThreshold = -40;
     const velocityThreshold = 0.5; // Fast left swipe snaps regardless of position

     const shouldReveal = mx < positionThreshold || (mx < -10 && vx < -velocityThreshold);

     if (shouldReveal) {
       // Snap to revealed
       setIsRevealed(true);
       if (setRowRef.current) {
         setRowRef.current.style.transform = 'translateX(-70px)';
       }
       onSwipeStateChange?.(true);
     } else {
       // Snap back
       resetSwipe();
     }
   }
   ```

   This allows:
   - Position-based snap: drag past -40px threshold
   - Velocity-based snap: fast left swipe (>0.5 px/ms) with at least -10px movement
  </action>
  <verify>TypeScript compiles: cd apps/web && pnpm exec tsc --noEmit</verify>
  <done>Velocity-based snap decision implemented</done>
</task>

<task type="auto">
  <name>Task 3: Add rubberband effect for over-drag</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx</files>
  <action>
1. UPDATE the drag constraint logic to add rubberband resistance beyond -80px:

   Replace the simple constraint (around line 112):
   ```typescript
   // Constrain to left swipe only, max -80px
   const x = Math.max(-80, Math.min(0, mx));
   ```

   With rubberband calculation:
   ```typescript
   // Constrain to left swipe only with rubberband past -80px
   const maxDrag = -80;
   let x: number;
   if (mx >= 0) {
     x = 0; // No right swipe
   } else if (mx >= maxDrag) {
     x = mx; // Normal drag range
   } else {
     // Rubberband: resistance increases past max
     // Every pixel past -80 adds only 0.2 pixels of movement
     const overDrag = mx - maxDrag;
     x = maxDrag + overDrag * 0.2;
   }
   ```

   This creates iOS-style rubberband where:
   - 0 to -80px: 1:1 finger tracking
   - Beyond -80px: 5:1 resistance (feels "heavy")
  </action>
  <verify>TypeScript compiles: cd apps/web && pnpm exec tsc --noEmit</verify>
  <done>Rubberband resistance effect implemented for over-drag</done>
</task>

<task type="auto">
  <name>Task 4: Fix delete button visibility during close gesture</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx</files>
  <action>
**Gap from Phase 6 UAT:** When swiping right to close a revealed row, the delete button stays visible until finger lifts. It should hide immediately when closing.

**Root cause:** Button visibility depends on `isDragging`, which stays true during the entire gesture.

**Fix:** Track "closing" state and exclude from button visibility.

1. ADD `isClosing` state after `isDragging`:
   ```typescript
   const [isDragging, setIsDragging] = useState(false);
   const [isClosing, setIsClosing] = useState(false);
   ```

2. UPDATE the useDrag callback to track closing state. After `setIsDragging(active);` add:
   ```typescript
   // Track if we're closing a revealed row (swiping right)
   // Button should hide immediately when closing
   if (isRevealed && active && mx > -60) {
     setIsClosing(true);
   } else if (!active) {
     setIsClosing(false);
   }
   ```

3. UPDATE the delete button visibility (around line 231):

   Replace:
   ```tsx
   style={{ visibility: canDelete && (isRevealed || isDragging) ? 'visible' : 'hidden' }}
   ```

   With:
   ```tsx
   style={{ visibility: canDelete && (isRevealed || isDragging) && !isClosing ? 'visible' : 'hidden' }}
   ```

4. UPDATE `resetSwipe` to also clear `isClosing`:
   ```typescript
   const resetSwipe = useCallback((): void => {
     setIsRevealed(false);
     setIsDragging(false);
     setIsClosing(false);
     if (setRowRef.current) {
       setRowRef.current.style.transform = '';
     }
     onSwipeStateChange?.(false);
   }, [onSwipeStateChange]);
   ```

**Behavior after fix:**
- Revealed row (-70px position)
- User starts swiping right (finger down, moving toward 0)
- As soon as mx > -60 (10px of rightward movement), `isClosing` becomes true
- Button immediately hides due to `&& !isClosing` condition
- Row continues to follow finger, snaps back on release
  </action>
  <verify>TypeScript compiles: cd apps/web && pnpm exec tsc --noEmit</verify>
  <done>Delete button hides immediately when closing revealed row</done>
</task>

<task type="auto">
  <name>Task 5: Verify complete implementation</name>
  <files>apps/web/src/surfaces/workout/SetRow.tsx, apps/web/css/styles.css</files>
  <action>
1. Run full TypeScript check: cd apps/web && pnpm exec tsc --noEmit
2. Run build: pnpm --filter @ironlift/web build
3. Verify velocity destructuring is used (not just declared)
4. Verify rubberband logic handles all cases (positive, normal, over-drag)
5. Verify CSS cubic-bezier values are valid
6. Verify isClosing state is used in button visibility
  </action>
  <verify>pnpm --filter @ironlift/web build succeeds</verify>
  <done>Build passes, all polish features implemented</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd apps/web && pnpm exec tsc --noEmit` passes
- [ ] `pnpm --filter @ironlift/web build` succeeds
- [ ] CSS transition uses spring-like cubic-bezier curve
- [ ] Velocity parameter destructured from useDrag
- [ ] Fast left swipe (>0.5 px/ms) triggers snap even if position < -40px
- [ ] Rubberband effect active when dragging past -80px
- [ ] Snap animation feels springy (overshoot then settle)
- [ ] Delete button hides immediately when swiping right to close (Phase 6 gap fix)
</verification>

<must_haves>
Goal-backward verification - Phase 7 goal: "Add spring animations and gesture refinements"

- [ ] Spring animation implemented (CSS cubic-bezier with overshoot)
- [ ] Velocity-based snap decision (fast swipes snap regardless of threshold)
- [ ] Rubberband over-drag effect (iOS-style resistance past boundary)
- [ ] Delete button hides immediately when closing revealed row (Phase 6 deferred issue)
- [ ] All existing swipe behavior preserved
- [ ] Build passes without errors
</must_haves>

<success_criteria>
- All tasks completed
- All verification checks pass
- Swipe gesture feels more natural and responsive
- Quick swipes snap without needing to reach threshold
- Over-drag shows resistance instead of hard stop
- Phase 7 complete, Milestone v2.6 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-swipe-polish/07-01-SUMMARY.md`
</output>
