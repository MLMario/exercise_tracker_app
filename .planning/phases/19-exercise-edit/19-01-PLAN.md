---
phase: 19-exercise-edit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/css/styles.css
  - apps/web/src/surfaces/dashboard/MyExercisesList.tsx
autonomous: true

must_haves:
  truths:
    - "User can tap pencil icon on an exercise row to expand an inline edit form"
    - "User can modify exercise name via text input pre-filled with current value"
    - "User can modify exercise category via native select dropdown pre-filled with current value"
    - "Save button is disabled until name or category differs from original"
    - "User can save edits and see changes reflected in the list immediately"
    - "User can cancel edits and see original values restored"
    - "Only one row can be expanded at a time; expanding another auto-collapses current"
  artifacts:
    - path: "apps/web/css/styles.css"
      provides: "Edit form accordion CSS classes"
      contains: "my-exercises-edit-form"
    - path: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      provides: "Accordion edit form with save/cancel"
      exports: ["MyExercisesList"]
  key_links:
    - from: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      to: "exercises.updateExercise"
      via: "import from @ironlift/shared, called on Save click"
      pattern: "exercises\\.updateExercise"
    - from: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      to: "exercises.getCategories"
      via: "import from @ironlift/shared, populates select options"
      pattern: "exercises\\.getCategories"
    - from: "apps/web/src/surfaces/dashboard/MyExercisesList.tsx"
      to: "result.validationError"
      via: "switch on typed validation errors to set inline field errors"
      pattern: "validationError"
---

<objective>
Add inline accordion editing to the My Exercises list so users can expand an exercise row, edit name and category, and save or cancel changes.

Purpose: Implements CRUD-02 through CRUD-06 -- the core edit capability for custom exercises.
Output: Enhanced MyExercisesList component with expand/collapse edit form and supporting CSS.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-exercise-edit/19-CONTEXT.md
@.planning/phases/19-exercise-edit/19-RESEARCH.md

@apps/web/src/surfaces/dashboard/MyExercisesList.tsx
@apps/web/css/styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edit form CSS styles</name>
  <files>apps/web/css/styles.css</files>
  <action>
Add new CSS rules AFTER the existing `.my-exercises-loading` block (around line 3153) in the "My Exercises List" section. Add these classes:

1. `.my-exercises-row` enhancements:
   - Add `flex-wrap: wrap` so the edit form can appear below the info row
   - Add `position: relative` for pencil icon positioning
   - Keep existing styles intact

2. `.my-exercises-edit-trigger` (pencil icon button):
   - `background: none; border: none; cursor: pointer; padding: var(--spacing-xs);`
   - `color: var(--color-text-muted); margin-left: auto;` (pushes to right side of row)
   - `font-size: 1.125rem; min-width: 44px; min-height: 44px;` (tap target)
   - `display: flex; align-items: center; justify-content: center;`

3. `.my-exercises-edit-form` (accordion container):
   - `width: 100%; max-height: 0; overflow: hidden;`
   - `transition: max-height 0.3s ease;`

4. `.my-exercises-row.editing .my-exercises-edit-form`:
   - `max-height: 280px;` (close to actual form height ~220px to avoid animation delay)

5. `.my-exercises-edit-form-inner` (form content with padding/background):
   - `padding: var(--spacing-md);`
   - `background: var(--color-bg-elevated);`
   - `border-radius: var(--radius-md);`
   - `margin-top: var(--spacing-sm);`
   - `display: flex; flex-direction: column; gap: var(--spacing-sm);`

6. `.my-exercises-edit-actions` (button row):
   - `display: flex; gap: var(--spacing-sm); justify-content: flex-end;`
   - `margin-top: var(--spacing-xs);`

7. `.field-error` (inline validation error text):
   - `color: var(--color-danger); font-size: 0.8125rem; margin-top: var(--spacing-xs);`

8. `.my-exercises-row.save-success`:
   - `background-color: rgba(74, 222, 128, 0.1);`
   - `transition: background-color 0.3s ease;`

Do NOT modify any existing CSS rules. Only ADD new rules.
  </action>
  <verify>
Grep styles.css for "my-exercises-edit-form" -- must find the new class.
Grep styles.css for "my-exercises-edit-trigger" -- must find the pencil button class.
Grep styles.css for "field-error" -- must find inline error class.
Grep styles.css for "save-success" -- must find success flash class.
  </verify>
  <done>All 8 CSS rule groups exist in styles.css. No existing rules were modified.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance MyExercisesList with accordion edit form</name>
  <files>apps/web/src/surfaces/dashboard/MyExercisesList.tsx</files>
  <action>
Enhance the existing MyExercisesList component to add inline accordion editing. The component currently renders a flat list of exercise rows. Add the following:

**New imports:**
- `useCallback` from `preact/hooks`
- `exercises` is already imported. Also import `type { ExerciseCategory }` from `@ironlift/shared` (needed for editCategory state typing)
- Use `type { JSX }` from `preact` for event typing

**New state variables (add after existing state):**
- `expandedId: string | null` (initially null) -- which exercise row is expanded
- `editName: string` (initially '') -- current value in name input
- `editCategory: ExerciseCategory` (initially 'Other') -- current value in category select
- `nameError: string` (initially '') -- inline validation error for name field
- `generalError: string` (initially '') -- general error above form
- `isSaving: boolean` (initially false) -- loading state during save
- `successId: string | null` (initially null) -- which row shows success flash

**Get categories list (call once, outside effects):**
```typescript
const categories = exercises.getCategories();
```

**Handler: handleEditClick(exercise: Exercise)**
Using useCallback. When pencil icon is tapped:
- If `expandedId === exercise.id`, collapse: set expandedId to null, return
- Otherwise: set expandedId to exercise.id, set editName to exercise.name, set editCategory to exercise.category, clear nameError and generalError

**Handler: handleCancel()**
Using useCallback. When Cancel button is tapped:
- Set expandedId to null (collapses form)
- Clear nameError and generalError

**Handler: handleSave()**
Using useCallback, depends on expandedId, editName, editCategory, userExercises. When Save button is tapped:
- Find the exercise from userExercises by expandedId. If not found, return.
- Set isSaving true, clear nameError and generalError
- Build params: `{ id: exercise.id }`. Only add `name: editName.trim()` if editName.trim() !== exercise.name. Only add `category: editCategory` if editCategory !== exercise.category.
- Call `const result = await exercises.updateExercise(params)`
- Set isSaving false
- If `result.validationError`:
  - `'EMPTY_NAME'` -> setNameError('Exercise name is required')
  - `'INVALID_NAME'` -> setNameError('Only letters, numbers, and spaces allowed')
  - `'DUPLICATE_NAME'` -> setNameError('An exercise with this name already exists')
- Else if `result.error` -> setGeneralError('Failed to save changes')
- Else if `result.data` (success):
  - Update userExercises: map over array, replace the matching exercise with result.data, then sort alphabetically by name (case-insensitive: `a.name.localeCompare(b.name)`)
  - Set successId to exercise.id
  - After 800ms timeout: set successId to null, set expandedId to null

**Dirty check (computed in render):**
```typescript
const currentExercise = userExercises.find(ex => ex.id === expandedId);
const hasChanges = currentExercise
  ? (editName.trim() !== currentExercise.name || editCategory !== currentExercise.category)
  : false;
```

**Updated JSX for each exercise row (replace current row rendering):**
Each row becomes:
```tsx
<div
  key={exercise.id}
  class={`my-exercises-row${expandedId === exercise.id ? ' editing' : ''}${successId === exercise.id ? ' save-success' : ''}`}
>
  <div class="exercise-item-info">
    <span class="exercise-item-name">{exercise.name}</span>
    <span class="exercise-item-category">{exercise.category}</span>
  </div>
  <button
    type="button"
    class="my-exercises-edit-trigger"
    onClick={() => handleEditClick(exercise)}
    aria-label={`Edit ${exercise.name}`}
  >
    &#9998;
  </button>
  <div class="my-exercises-edit-form">
    <div class="my-exercises-edit-form-inner">
      {generalError && <div class="error-message">{generalError}</div>}
      <div>
        <input
          type="text"
          value={editName}
          onInput={(e: JSX.TargetedEvent<HTMLInputElement>) => {
            setEditName(e.currentTarget.value);
            setNameError('');
          }}
          placeholder="Exercise name"
          disabled={isSaving}
        />
        {nameError && <div class="field-error">{nameError}</div>}
      </div>
      <div>
        <select
          value={editCategory}
          onChange={(e: JSX.TargetedEvent<HTMLSelectElement>) => {
            setEditCategory(e.currentTarget.value as ExerciseCategory);
          }}
          disabled={isSaving}
        >
          {categories.map(cat => (
            <option key={cat} value={cat}>{cat}</option>
          ))}
        </select>
      </div>
      <div class="my-exercises-edit-actions">
        <button
          type="button"
          class="btn btn-secondary"
          onClick={handleCancel}
          disabled={isSaving}
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onClick={handleSave}
          disabled={!hasChanges || isSaving}
        >
          {isSaving ? 'Saving...' : 'Save'}
        </button>
      </div>
    </div>
  </div>
</div>
```

Note: The `hasChanges` check must be computed per-render (not inside the map). Since only the expanded row shows the form, the single `hasChanges` variable works -- it always refers to the currently expanded exercise.

**Important Preact notes:**
- Use `onInput` not `onChange` for text inputs (Preact convention for real-time updates)
- Event types use `JSX.TargetedEvent<HTMLInputElement>` and `JSX.TargetedEvent<HTMLSelectElement>`
- The pencil character `&#9998;` renders as a pencil icon (Unicode U+270E). Alternatively use the literal character if preferred.

**Do NOT:**
- Use `useAsyncOperation` hook (per Research decision -- typed validation errors need manual handling)
- Add auto-save behavior (CONTEXT.md explicitly requires explicit Save button)
- Show a warning dialog on unsaved changes when switching rows (CONTEXT.md says discard silently)
- Create a separate component file -- keep everything in MyExercisesList.tsx
  </action>
  <verify>
1. Run `npx tsc --noEmit` from the project root -- zero errors
2. Grep MyExercisesList.tsx for "updateExercise" -- must find the service call
3. Grep MyExercisesList.tsx for "getCategories" -- must find category list usage
4. Grep MyExercisesList.tsx for "expandedId" -- must find accordion state
5. Grep MyExercisesList.tsx for "validationError" -- must find error mapping
6. Grep MyExercisesList.tsx for "hasChanges" -- must find dirty check
7. Grep MyExercisesList.tsx for "successId" -- must find success flash logic
8. Grep MyExercisesList.tsx for "handleCancel" -- must find cancel handler
  </verify>
  <done>
CRUD-02: Pencil icon on each row expands inline edit form with accordion animation.
CRUD-03: Text input pre-filled with exercise name, editable.
CRUD-04: Native select dropdown pre-filled with exercise category, all categories available.
CRUD-05: Save button calls updateExercise, updates local state, shows success flash, auto-collapses. Disabled until changes made.
CRUD-06: Cancel button collapses form and discards changes. Validation errors display inline below name field.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with zero errors
2. CSS classes exist: grep styles.css for `my-exercises-edit-form`, `my-exercises-edit-trigger`, `field-error`, `save-success`
3. Component integrations: MyExercisesList imports and calls `exercises.updateExercise` and `exercises.getCategories`
4. Accordion behavior: `expandedId` state controls single-expansion; CSS `max-height` transition provides animation
5. Validation: `validationError` from updateExercise is mapped to inline error messages
6. Dirty check: Save button disabled when `editName === originalName && editCategory === originalCategory`
7. Success flash: `successId` state triggers `.save-success` class with 800ms timeout before collapse
</verification>

<success_criteria>
- CRUD-02: Tapping pencil icon expands inline edit form; tapping again or tapping another row's icon collapses it
- CRUD-03: Name text input is pre-filled and editable; validation errors show inline below field
- CRUD-04: Category dropdown is pre-filled with current category; all 7 categories available
- CRUD-05: Save calls updateExercise, updates list in-place with re-sort, shows success flash, auto-collapses
- CRUD-06: Cancel collapses form, original values restored in list (unchanged)
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-exercise-edit/19-01-SUMMARY.md`
</output>
