---
phase: 06-auth-surface
plan: 03
type: execute
depends_on: ["06-02"]
files_modified: [src/surfaces/auth/ResetPasswordForm.tsx, src/surfaces/auth/UpdatePasswordForm.tsx, src/surfaces/auth/AuthSurface.tsx]
---

<objective>
Create password recovery flow components and wire up auth state change listener.

Purpose: Complete the auth surface with password reset request and update flows.
Output: Working password recovery flow matching existing Alpine.js behavior, fully integrated AuthSurface.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-auth-surface/06-02-SUMMARY.md

**Source reference for exact behavior:**
@js/app.js (lines 242-267) - handlePasswordReset method
@js/app.js (lines 273-308) - handlePasswordUpdate method
@js/app.js (lines 310-318) - goToLoginAfterPasswordUpdate method
@js/app.js (lines 90-158) - init() with PASSWORD_RECOVERY handling
@index.html (lines 174-300) - Reset and Update password HTML

**Key behavior to preserve:**
- PASSWORD_RECOVERY event sets isPasswordRecoveryMode flag
- Flag prevents SIGNED_IN from overriding updatePassword surface
- URL hash type=recovery detected on init
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ResetPasswordForm and UpdatePasswordForm components</name>
  <files>src/surfaces/auth/ResetPasswordForm.tsx, src/surfaces/auth/UpdatePasswordForm.tsx</files>
  <action>
Create ResetPasswordForm.tsx with props:
- email, setEmail
- error, isLoading
- resetEmailSent (boolean - shows success state)
- onSubmit (handlePasswordReset)
- onBackToLogin (switch to login)

Render matching index.html lines 174-214:
- "← Back to login" link
- Title "Reset Password" with description
- Success message when resetEmailSent is true
- Email input (hidden when resetEmailSent)
- Submit button ("Sending..." vs "Send Reset Link")
- Error message display

Create UpdatePasswordForm.tsx with props:
- password, setPassword
- confirmPassword, setConfirmPassword
- showPassword, showConfirmPassword
- onTogglePassword
- error, isLoading
- passwordUpdateSuccess (boolean - shows success state)
- onSubmit (handlePasswordUpdate)
- onGoToLogin (goToLoginAfterPasswordUpdate)

Render matching index.html lines 216-300:
- Title "Set New Password" with description
- Success state template with "Go to Login" button
- Form state (when not success):
  - New password input with visibility toggle
  - Confirm password input with visibility toggle
  - Password hint
  - Submit button ("Updating..." vs "Update Password")
- Error message display

Both components are controlled - all state from parent.
  </action>
  <verify>Both components render correctly with mock props</verify>
  <done>ResetPasswordForm.tsx and UpdatePasswordForm.tsx exist with all UI elements</done>
</task>

<task type="auto">
  <name>Task 2: Integrate password flows and auth state listener into AuthSurface</name>
  <files>src/surfaces/auth/AuthSurface.tsx</files>
  <action>
Import ResetPasswordForm and UpdatePasswordForm.

Implement handlePasswordReset (from js/app.js lines 242-267):
- Validate email is provided
- Call auth.resetPassword(email)
- On success: set resetEmailSent = true, successMessage
- On error: set error state

Implement handlePasswordUpdate (from js/app.js lines 273-308):
- Validate passwords match
- Validate password length >= 6
- Call auth.updateUser(password)
- On success: set passwordUpdateSuccess = true, clear password fields
- On error: set error state

Implement goToLoginAfterPasswordUpdate (from js/app.js lines 310-318):
- Reset passwordUpdateSuccess, isPasswordRecoveryMode
- Switch to login surface
- Clear error/success messages

Add useEffect for auth state change listener (from js/app.js lines 107-137):
- Call auth.onAuthStateChange with callback
- Handle PASSWORD_RECOVERY event: set isPasswordRecoveryMode, switch to updatePassword
- Handle SIGNED_IN: if isPasswordRecoveryMode, ignore; otherwise would navigate to dashboard (for now just log)
- Return cleanup function to unsubscribe

Add useEffect for URL hash detection on mount (from js/app.js lines 96-105):
- Check window.location.hash for type=recovery
- If found, set isPasswordRecoveryMode and authSurface to updatePassword

Update render to show:
- ResetPasswordForm when authSurface === 'reset'
- UpdatePasswordForm when authSurface === 'updatePassword'
- Hide tabs when on reset or updatePassword surfaces
- Update footer text based on current surface

Complete the AuthSurface by ensuring all 4 sub-surfaces work correctly.
  </action>
  <verify>npm run build succeeds, password reset flow works end-to-end (request → email → update)</verify>
  <done>All 4 auth sub-surfaces work, PASSWORD_RECOVERY event handled, auth state listener integrated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] ResetPasswordForm renders with back link, email input, success state
- [ ] UpdatePasswordForm renders with password inputs, success state, go to login
- [ ] handlePasswordReset calls auth.resetPassword()
- [ ] handlePasswordUpdate calls auth.updateUser()
- [ ] Auth state change listener set up in useEffect
- [ ] PASSWORD_RECOVERY event switches to updatePassword surface
- [ ] URL hash type=recovery detected on mount
- [ ] All 4 auth surfaces navigate correctly
- [ ] Phase 6 complete: full auth surface migrated to Preact
</verification>

<success_criteria>

- Password reset request flow works
- Password update flow works
- PASSWORD_RECOVERY event handling preserved
- URL hash detection works
- All auth surfaces complete
- Phase 6: Auth Surface complete
</success_criteria>

<output>
After completion, create `.planning/phases/06-auth-surface/06-03-SUMMARY.md`
</output>
