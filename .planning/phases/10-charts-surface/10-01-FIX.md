---
phase: 10-charts-surface
plan: 10-01-FIX
type: fix
---

<objective>
Fix 1 UAT issue from plan 10-01.

Source: 10-01-ISSUES.md
Priority: 1 blocker, 0 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/10-charts-surface/10-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/10-charts-surface/10-01-PLAN.md

**Files involved:**
@src/surfaces/dashboard/ChartSection.tsx
@src/surfaces/dashboard/ChartCard.tsx
@src/surfaces/dashboard/DashboardSurface.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-001 - Chart blank on page refresh</name>
  <files>src/surfaces/dashboard/ChartCard.tsx, src/surfaces/dashboard/ChartSection.tsx, src/surfaces/dashboard/DashboardSurface.tsx</files>
  <action>
**Root cause:** The `setTimeout(0)` in ChartSection.useEffect is not reliable for ensuring canvas elements are in the DOM after Preact renders. On page refresh, `renderAllCharts` runs before the canvas elements from ChartCard exist in the DOM, causing `document.getElementById` to return null.

**Fix approach:** Move chart rendering responsibility to ChartCard using useRef for the canvas element and useEffect for rendering when the canvas ref becomes available. This ensures each chart renders when its own canvas is mounted.

**Implementation changes:**

1. **ChartCard.tsx** - Add ref-based chart rendering:
   - Add `useRef<HTMLCanvasElement>` for canvas element
   - Add `useEffect` that renders chart when canvas ref is set and chartData is provided
   - Add new prop `chartData` (labels/values) and `onChartRendered` callback
   - Use `ref={canvasRef}` on the canvas element instead of just id
   - Call `window.charts.renderChart` inside useEffect when canvasRef.current exists
   - Call cleanup via `window.charts.destroyChart` on unmount

2. **ChartSection.tsx** - Remove setTimeout-based rendering:
   - Remove the `useEffect` with `setTimeout(onRenderCharts, 0)`
   - Remove `onRenderCharts` prop - no longer needed
   - Pass chart data to each ChartCard for self-rendering

3. **DashboardSurface.tsx** - Fetch chart data upfront:
   - Modify `loadUserCharts` to also fetch metrics data for each chart
   - Store chart data in state alongside chart config
   - Remove `renderAllCharts` and `onRenderCharts` prop from ChartSection
   - Keep chartInstancesRef for tracking instances (for cleanup)
   - Add callback from ChartCard to register rendered instances

**Key insight:** By making ChartCard responsible for its own rendering via useRef + useEffect, we guarantee the canvas exists in DOM before attempting to render to it.
  </action>
  <verify>
1. npm run build succeeds
2. Dev server: Charts render correctly on initial navigation
3. Dev server: F5 refresh - charts re-render correctly (not blank)
4. Dev server: Closing and reopening localhost - charts render correctly
5. Delete button works on rendered charts
6. Add chart modal works and new chart renders
  </verify>
  <done>
- Charts render on page refresh (F5)
- Charts render when reopening localhost in new tab
- No console errors about null canvas
- Original acceptance criteria from UAT-001 met
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] All critical issues fixed (UAT-001 resolved)
- [ ] Charts render correctly on page refresh
- [ ] Charts render correctly on new tab open
- [ ] No JavaScript errors in console related to chart rendering
- [ ] Add/delete chart functionality still works
</verification>

<success_criteria>
- UAT-001 from 10-01-ISSUES.md fixed
- Tests pass (if applicable)
- Ready for re-verification with /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/10-charts-surface/10-01-FIX-SUMMARY.md`
</output>
