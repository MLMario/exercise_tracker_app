---
phase: 05-data-services
plan: 02
type: execute
depends_on: []
files_modified: [src/services/templates.ts, src/services/index.ts]
---

<objective>
Migrate templates service from js/templates.js to TypeScript with full type safety.

Purpose: Enable type-safe template CRUD operations with complex nested data handling.
Output: Working templates service with backward compatibility via window.templates export.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-auth-service/04-01-SUMMARY.md

# Type definitions already exist:
@src/types/database.ts
@src/types/services.ts

# Pattern to follow:
@src/services/auth.ts

# Source to migrate:
@js/templates.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create templates service module</name>
  <files>src/services/templates.ts</files>
  <action>
Create TypeScript implementation of TemplatesService interface from src/types/services.ts.

Implement all 8 functions with exact behavioral parity to js/templates.js:

1. getTemplates() - Fetch all templates with nested template_exercises, exercises, and template_exercise_sets. Transform to TemplateWithExercises[] format (sort by order, map sets).

2. getTemplate(id) - Fetch single template by ID with same nested structure.

3. createTemplate(name, exercises) - Create template, then insert template_exercises with order, then insert template_exercise_sets. Include rollback on failure (delete template if exercises fail).

4. updateTemplate(id, name, exercises) - Update name and updated_at, delete existing template_exercises, insert new ones with sets.

5. deleteTemplate(id) - Delete by ID with user_id check.

6. addExerciseToTemplate(templateId, exercise) - Get max order, insert at maxOrder+1, create 3 default sets (weight: 0, reps: 10), update template's updated_at.

7. removeExerciseFromTemplate(templateId, exerciseId) - Delete template_exercise, update template's updated_at.

8. updateTemplateExercise(templateId, exerciseId, defaults) - Update default_rest_seconds, update template's updated_at.

Critical data transformation in getTemplates:
- Sort template_exercises by order
- Sort template_exercise_sets by set_number
- Map to TemplateExerciseWithSets format (exercise_id, name, category, default_rest_seconds, sets)

Follow auth.ts patterns:
- Import types from @/types/services and @/types/database
- Import supabase from @/lib/supabase
- Use try/catch with appropriate error handling
- Return ServiceResult<T> or ServiceError types
- Export as `templates` object implementing TemplatesService
- Add window.templates export for backward compatibility

AVOID: Don't change the nested query structure - preserve exact Supabase select syntax. The rollback pattern (delete on failure) must be preserved.
  </action>
  <verify>npx tsc --noEmit passes without errors</verify>
  <done>All 8 functions implemented with exact behavioral parity to js/templates.js, including nested data transformation</done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export and verify build</name>
  <files>src/services/index.ts</files>
  <action>
Add templates service to the barrel export:
- Export { templates } from './templates'
- Also export the TemplatesService type from the module

Verify the complete build succeeds.
  </action>
  <verify>npm run build succeeds without errors or warnings</verify>
  <done>Templates service exported via barrel, build passes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] All 8 TemplatesService interface methods implemented
- [ ] Nested data transformation (exercises with sets) works correctly
- [ ] window.templates backward compatibility export present
- [ ] No behavioral changes from js/templates.js
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Templates service matches TemplatesService interface
- Complex nested queries preserve exact behavior
- Backward compatible with existing js/app.js usage
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-services/05-02-SUMMARY.md`
</output>
